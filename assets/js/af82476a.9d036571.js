"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[93954],{38261:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var a=t(85893),s=t(11151);const o={slug:"fundamentals-day-1",title:"2-1. Kubernetes Fundamentals - Pods and Deployments",authors:["steven"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["pods","deployments","kubernetes","aks","container-apps","cloud-native"],image:"https://azure.github.io/Cloud-Native/img/og/30-06.png",description:"The theme for this week is Kubernetes fundamentals. Today we'll explore the topic of Pods and Deployments in Kubernetes.",tags:["cloud-native","30daysofcloudnative","zero-to-hero","ask-the-expert","azure-kubernetes-service"]},i=void 0,r={permalink:"/Cloud-Native/cnny-2023/fundamentals-day-1",source:"@site/blog-cnny/2023-01-30/PodsAndDeployments.md",title:"2-1. Kubernetes Fundamentals - Pods and Deployments",description:"The theme for this week is Kubernetes fundamentals. Today we'll explore the topic of Pods and Deployments in Kubernetes.",date:"2023-01-30T00:00:00.000Z",formattedDate:"January 30, 2023",tags:[{label:"cloud-native",permalink:"/Cloud-Native/cnny-2023/tags/cloud-native"},{label:"30daysofcloudnative",permalink:"/Cloud-Native/cnny-2023/tags/30-daysofcloudnative"},{label:"zero-to-hero",permalink:"/Cloud-Native/cnny-2023/tags/zero-to-hero"},{label:"ask-the-expert",permalink:"/Cloud-Native/cnny-2023/tags/ask-the-expert"},{label:"azure-kubernetes-service",permalink:"/Cloud-Native/cnny-2023/tags/azure-kubernetes-service"}],readingTime:13.16,hasTruncateMarker:!1,authors:[{name:"Steven Murawski",title:"Principal Cloud Advocate",url:"https://github.com/smurawski",imageURL:"https://github.com/smurawski.png",key:"steven"}],frontMatter:{slug:"fundamentals-day-1",title:"2-1. Kubernetes Fundamentals - Pods and Deployments",authors:["steven"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["pods","deployments","kubernetes","aks","container-apps","cloud-native"],image:"https://azure.github.io/Cloud-Native/img/og/30-06.png",description:"The theme for this week is Kubernetes fundamentals. Today we'll explore the topic of Pods and Deployments in Kubernetes.",tags:["cloud-native","30daysofcloudnative","zero-to-hero","ask-the-expert","azure-kubernetes-service"]},unlisted:!1,prevItem:{title:"1-5. Exploring Cloud-Native Options",permalink:"/Cloud-Native/cnny-2023/explore-options"},nextItem:{title:"2-2. Kubernetes Fundamentals - Services and Ingress",permalink:"/Cloud-Native/cnny-2023/fundamentals-day-2"}},l={authorsImageUrls:[void 0]},d=[{value:"What We&#39;ll Cover",id:"what-well-cover",level:2},{value:"Setting Up A Kubernetes Environment in Azure",id:"setting-up-a-kubernetes-environment-in-azure",level:2},{value:"Step 0 - Prerequisites",id:"step-0---prerequisites",level:3},{value:"Step 1 - Clone the application repository",id:"step-1---clone-the-application-repository",level:3},{value:"Step 2 - Set up AKS",id:"step-2---set-up-aks",level:3},{value:"Step 3 - Build our application container",id:"step-3---build-our-application-container",level:3},{value:"Running Containers in Kubernetes Pods",id:"running-containers-in-kubernetes-pods",level:2},{value:"The Pod",id:"the-pod",level:3},{value:"Creating a Pod Definition",id:"creating-a-pod-definition",level:3},{value:"Now that the Application is Running",id:"now-that-the-application-is-running",level:3},{value:"Clean Up",id:"clean-up",level:3},{value:"Summary - Pods",id:"summary---pods",level:3},{value:"Making the Pods Resilient with Deployments",id:"making-the-pods-resilient-with-deployments",level:2},{value:"Breaking Stuff",id:"breaking-stuff",level:3},{value:"Setting Back Up",id:"setting-back-up",level:4},{value:"Knocking It Down",id:"knocking-it-down",level:4},{value:"Uncomfortable Truths",id:"uncomfortable-truths",level:4},{value:"The Deployment",id:"the-deployment",level:3},{value:"Creating the Deployment",id:"creating-the-deployment",level:4},{value:"Clean up",id:"clean-up-1",level:3},{value:"Summary - Deployments",id:"summary---deployments",level:3},{value:"Exercise",id:"exercise",level:2},{value:"Resources",id:"resources",level:2},{value:"Documentation",id:"documentation",level:3},{value:"Training",id:"training",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components},{Head:o}=n;return o||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(o,{children:[(0,a.jsx)("meta",{name:"twitter:url",content:"https://azure.github.io/Cloud-Native/cnny-2023/fundamentals-day-1"}),(0,a.jsx)("meta",{name:"twitter:title",content:"2-1. Kubernetes Fundamentals - Pods and Deployments"}),(0,a.jsx)("meta",{name:"twitter:description",content:"The theme for this week is Kubernetes fundamentals. Today we'll explore the topic of Pods and Deployments in Kubernetes."}),(0,a.jsx)("meta",{name:"twitter:image",content:"https://azure.github.io/Cloud-Native/img/og/30-06.png"}),(0,a.jsx)("meta",{name:"twitter:card",content:"summary_large_image"}),(0,a.jsx)("meta",{name:"twitter:creator",content:"@stevenmurawski"}),(0,a.jsx)("meta",{name:"twitter:site",content:"@AzureAdvocates"}),(0,a.jsx)("link",{rel:"canonical",href:"https://azure.github.io/Cloud-Native/cnny-2023/fundamentals-day-1"})]}),"\n",(0,a.jsxs)(n.p,{children:["Welcome to ",(0,a.jsx)(n.code,{children:"Day #1 of Week 2"})," of #CloudNativeNewYear!"]}),"\n",(0,a.jsx)(n.p,{children:"The theme for this week is Kubernetes fundamentals. Last week we talked about Cloud Native architectures and the Cloud Native landscape. Today we'll explore the topic of Pods and Deployments in Kubernetes."}),"\n",(0,a.jsx)(n.admonition,{title:"Ask the Experts Thursday, February 9th at 9 AM PST",type:"tip",children:(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://aka.ms/cnny/watch-ate",children:"Watch our Q&A with Experts from the Azure Kubernetes Service product team!"})})}),"\n",(0,a.jsxs)(n.admonition,{title:"Catch the Replay of the Live Demo",type:"tip",children:[(0,a.jsx)(n.p,{children:"Watch the recorded demo and conversation about this week's topics."}),(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://aka.ms/cnny/week2-demo",children:"We were live on YouTube walking through today's (and the rest of this week's) demos"}),"."]})]}),"\n",(0,a.jsx)(n.h2,{id:"what-well-cover",children:"What We'll Cover"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Setting Up A Kubernetes Environment in Azure"}),"\n",(0,a.jsx)(n.li,{children:"Running Containers in Kubernetes Pods"}),"\n",(0,a.jsx)(n.li,{children:"Making the Pods Resilient with Deployments"}),"\n",(0,a.jsx)(n.li,{children:"Exercise"}),"\n",(0,a.jsx)(n.li,{children:"Resources"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"setting-up-a-kubernetes-environment-in-azure",children:"Setting Up A Kubernetes Environment in Azure"}),"\n",(0,a.jsxs)(n.p,{children:["For this week, we'll be working with a simple app - ",(0,a.jsx)(n.a,{href:"https://aka.ms/azure-voting-app-rust",children:"the Azure Voting App"}),". My teammate ",(0,a.jsx)(n.a,{href:"https://github.com/pauldotyu",children:"Paul Yu"})," ported the app to Rust and we tweaked it a bit to let us highlight some of the basic features of Kubernetes."]}),"\n",(0,a.jsxs)(n.p,{children:["You should be able to replicate this in just about any Kubernetes environment, but we'll use ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=containers-84290-stmuraws",children:"Azure Kubernetes Service"})," (AKS) as our working environment for this week."]}),"\n",(0,a.jsxs)(n.p,{children:["To make it easier to get started, there's a ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?WT.mc_id=containers-84290-stmuraws&tabs=bicep",children:"Bicep"})," template to deploy an AKS cluster, an Azure Container Registry (ACR) (to host our container image), and connect the two so that we can easily deploy our application."]}),"\n",(0,a.jsx)(n.h3,{id:"step-0---prerequisites",children:"Step 0 - Prerequisites"}),"\n",(0,a.jsx)(n.p,{children:"There are a few things you'll need if you want to work through this and the following examples this week."}),"\n",(0,a.jsx)(n.p,{children:"Required:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Git (and probably a GitHub account if you want to persist your work outside of your computer)"}),"\n",(0,a.jsx)(n.li,{children:"Azure CLI"}),"\n",(0,a.jsx)(n.li,{children:"An Azure subscription (if you want to follow along with the Azure steps)"}),"\n",(0,a.jsx)(n.li,{children:"Kubectl (the command line tool for managing Kubernetes)"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Helpful:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Visual Studio Code (or equivalent editor)"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"step-1---clone-the-application-repository",children:"Step 1 - Clone the application repository"}),"\n",(0,a.jsxs)(n.p,{children:["First, I forked ",(0,a.jsx)(n.a,{href:"https://aka.ms/azure-voting-app-rust",children:"the source repository"})," to my account."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"$GitHubOrg = 'smurawski' # Replace this with your GitHub account name or org name\ngit clone \"https://github.com/$GitHubOrg/azure-voting-app-rust\"\ncd azure-voting-app-rust\n"})}),"\n",(0,a.jsx)(n.p,{children:"Leave your shell opened with your current location inside the application repository."}),"\n",(0,a.jsx)(n.h3,{id:"step-2---set-up-aks",children:"Step 2 - Set up AKS"}),"\n",(0,a.jsxs)(n.p,{children:["Running the template deployment from the demo script (I'm using the PowerShell example in ",(0,a.jsx)(n.a,{href:"https://aka.ms/azure-voting-app-rust/setup-powershell",children:"cnny23-week2-day1.ps1"}),", but there's a Bash variant at ",(0,a.jsx)(n.a,{href:"https://aka.ms/azure-voting-app-rust/setup-bash",children:"cnny23-week2-day1.sh"}),") stands up the environment.  The second, third, and fourth commands take some of the output from the Bicep deployment to set up for later commands, so don't close out your shell after you run these commands."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"az deployment sub create --template-file ./deploy/main.bicep --location eastus --parameters 'resourceGroup=cnny-week2'\n$AcrName = az deployment sub show --name main --query 'properties.outputs.acr_name.value' -o tsv\n$AksName = az deployment sub show --name main --query 'properties.outputs.aks_name.value' -o tsv\n$ResourceGroup = az deployment sub show --name main --query 'properties.outputs.resource_group_name.value' -o tsv\n\naz aks get-credentials --resource-group $ResourceGroup --name $AksName\n"})}),"\n",(0,a.jsx)(n.h3,{id:"step-3---build-our-application-container",children:"Step 3 - Build our application container"}),"\n",(0,a.jsx)(n.p,{children:"Since we have an Azure Container Registry set up, I'll use ACR Build Tasks to build and store my container image."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"az acr build --registry $AcrName --% --image cnny2023/azure-voting-app-rust:{{.Run.ID}} .\n$BuildTag = az acr repository show-tags `\n                              --name $AcrName `\n                              --repository cnny2023/azure-voting-app-rust `\n                              --orderby time_desc `\n                              --query '[0]' -o tsv\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsxs)(n.p,{children:["Wondering what the ",(0,a.jsx)(n.code,{children:"--%"}),' is in the first command line?  That tells the PowerShell interpreter to pass the input after it "as is" to the command without parsing/evaluating it. Otherwise, PowerShell messes a bit with the templated ',(0,a.jsx)(n.code,{children:"{{.Run.ID}}"})," bit."]})}),"\n",(0,a.jsx)(n.h2,{id:"running-containers-in-kubernetes-pods",children:"Running Containers in Kubernetes Pods"}),"\n",(0,a.jsx)(n.p,{children:"Now that we have our AKS cluster and application image ready to go, let's look into how Kubernetes runs containers."}),"\n",(0,a.jsx)(n.p,{children:"If you've been in tech for any length of time, you've seen that every framework, runtime, orchestrator, etc.. can have their own naming scheme for their concepts. So let's get into some of what Kubernetes calls things."}),"\n",(0,a.jsx)(n.h3,{id:"the-pod",children:"The Pod"}),"\n",(0,a.jsxs)(n.p,{children:["A container running in Kubernetes is called a ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/concepts-clusters-workloads?WT.mc_id=containers-84290-stmuraws#pods",children:"Pod"}),". A Pod is basically a running container on a ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/concepts-clusters-workloads?WT.mc_id=containers-84290-stmuraws#nodes-and-node-pools",children:"Node"})," or VM. It can be more. For example you can run multiple containers and specify some funky configuration, but we'll keep it simple for now - add the complexity when you need it."]}),"\n",(0,a.jsxs)(n.p,{children:["Our Pod definition can be created via the ",(0,a.jsx)(n.code,{children:"kubectl"})," command imperatively from arguments or declaratively from a configuration file.  We'll do a little of both.  We'll use the ",(0,a.jsx)(n.code,{children:"kubectl"})," command to help us write our configuration files.  Kubernetes configuration files are YAML, so having an editor that supports and can help you syntax check YAML is really helpful."]}),"\n",(0,a.jsx)(n.h3,{id:"creating-a-pod-definition",children:"Creating a Pod Definition"}),"\n",(0,a.jsx)(n.p,{children:"Let's create a few Pod definitions.  Our application requires two containers to get working - the application and a database."}),"\n",(0,a.jsx)(n.p,{children:"Let's create the database Pod first.  And before you comment, the configuration isn't secure nor best practice.  We'll fix that later this week.  For now, let's focus on getting up and running."}),"\n",(0,a.jsxs)(n.p,{children:["This is a trick I learned from one of my teammates - Paul.  By using the ",(0,a.jsx)(n.code,{children:"--output yaml"})," and ",(0,a.jsx)(n.code,{children:"--dry-run=client"})," options, we can have the command help us write our YAML.  And with a bit of output redirection, we can stash it safely in a file for later use."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:'kubectl run azure-voting-db `\n            --image "postgres:15.0-alpine" `\n            --env "POSTGRES_PASSWORD=mypassword" `\n            --output yaml `\n            --dry-run=client > manifests/pod-db.yaml\n'})}),"\n",(0,a.jsx)(n.p,{children:"This creates a file that looks like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: null\n  labels:\n    run: azure-voting-db\n  name: azure-voting-db\nspec:\n  containers:\n  - env:\n    - name: POSTGRES_PASSWORD\n      value: mypassword\n    image: postgres:15.0-alpine\n    name: azure-voting-db\n    resources: {}\n  dnsPolicy: ClusterFirst\n  restartPolicy: Always\nstatus: {}\n"})}),"\n",(0,a.jsx)(n.p,{children:"The file, when supplied to the Kubernetes API, will identify what kind of resource to create, the API version to use, and the details of the container (as well as an environment variable to be supplied)."}),"\n",(0,a.jsxs)(n.p,{children:["We'll get that container image started with the ",(0,a.jsx)(n.code,{children:"kubectl"})," command.  Because the details of what to create are in the file, we don't need to specify much else to the ",(0,a.jsx)(n.code,{children:"kubectl"})," command but the path to the file."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl apply -f ./manifests/pod-db.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["I'm going to need the IP address of the Pod, so that my application can connect to it, so we can use ",(0,a.jsx)(n.code,{children:"kubectl"})," to get some information about our pod.  By default, ",(0,a.jsx)(n.code,{children:"kubectl get pod"})," only displays certain information but it retrieves a lot more.  We can use the ",(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/kubectl/jsonpath/",children:"JSONPath syntax"})," to index into the response and get the information you want."]}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsxs)(n.p,{children:["To see what you can get, I usually run the ",(0,a.jsx)(n.code,{children:"kubectl"})," command with the output type (",(0,a.jsx)(n.code,{children:"-o JSON"}),") of JSON and then I can find where the data I want is and create my JSONPath query to get it."]})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell,",children:"$DB_IP = kubectl get pod azure-voting-db -o jsonpath='{.status.podIP}'\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now, let's create our Pod definition for our application.  We'll use the same technique as before."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:'kubectl run azure-voting-app `\n            --image "$AcrName.azurecr.io/cnny2023/azure-voting-app-rust:$BuildTag" `\n            --env "DATABASE_SERVER=$DB_IP" `\n            --env "DATABASE_PASSWORD=mypassword`\n            --output yaml `\n            --dry-run=client > manifests/pod-app.yaml\n'})}),"\n",(0,a.jsxs)(n.p,{children:["That command gets us a similar YAML file to the database container - you can see ",(0,a.jsx)(n.a,{href:"https://github.com/azure-samples/azure-voting-app-rust/blob/week2/day1/manifests/pod-app.yaml",children:"the full file here"})]}),"\n",(0,a.jsx)(n.p,{children:"Let's get our application container running."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl apply -f ./manifests/pod-app.yaml\n"})}),"\n",(0,a.jsx)(n.h3,{id:"now-that-the-application-is-running",children:"Now that the Application is Running"}),"\n",(0,a.jsx)(n.p,{children:"We can check the status of our Pods with:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl get pods\n"})}),"\n",(0,a.jsx)(n.p,{children:"And we should see something like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"azure-voting-app-rust \u276f  kubectl get pods\nNAME               READY   STATUS    RESTARTS   AGE\nazure-voting-app   1/1     Running   0          36s\nazure-voting-db    1/1     Running   0          84s\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Once our pod is running, we can check to make sure everything is working by letting ",(0,a.jsx)(n.code,{children:"kubectl"})," proxy network connections to our Pod running the application. If we get the voting web page, we'll know the application found the database and we can start voting!"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl port-forward pod/azure-voting-app 8080:8080\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Azure voting website in a browser with three buttons, one for Dogs, one for Cats, and one for Reset.  The counter is Dogs - 0 and Cats - 0.",src:t(31506).Z+"",width:"1590",height:"1137"})}),"\n",(0,a.jsx)(n.p,{children:"When you are done voting, you can stop the port forwarding by using Control-C to break the command."}),"\n",(0,a.jsx)(n.h3,{id:"clean-up",children:"Clean Up"}),"\n",(0,a.jsx)(n.p,{children:"Let's clean up after ourselves and see if we can't get Kubernetes to help us keep our application running.  We can use the same configuration files to ensure that Kubernetes only removes what we want removed."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl delete -f ./manifests/pod-app.yaml\nkubectl delete -f ./manifests/pod-db.yaml\n"})}),"\n",(0,a.jsx)(n.h3,{id:"summary---pods",children:"Summary - Pods"}),"\n",(0,a.jsx)(n.p,{children:"A Pod is the most basic unit of work inside Kubernetes. Once the Pod is deleted, it's gone.  That leads us to our next topic (and final topic for today.)"}),"\n",(0,a.jsx)(n.h2,{id:"making-the-pods-resilient-with-deployments",children:"Making the Pods Resilient with Deployments"}),"\n",(0,a.jsx)(n.p,{children:"We've seen how easy it is to deploy a Pod and get our containers running on Nodes in our Kubernetes cluster.  But there's a problem with that.  Let's illustrate it."}),"\n",(0,a.jsx)(n.h3,{id:"breaking-stuff",children:"Breaking Stuff"}),"\n",(0,a.jsx)(n.h4,{id:"setting-back-up",children:"Setting Back Up"}),"\n",(0,a.jsx)(n.p,{children:"First, let's redeploy our application environment.  We'll start with our application container."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl apply -f ./manifests/pod-db.yaml\nkubectl get pod azure-voting-db -o jsonpath='{.status.podIP}'\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The second command will report out the new IP Address for our database container.  Let's open ",(0,a.jsx)(n.code,{children:"./manifests/pod-app.yaml"})," and update the container IP to our new one."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yml",children:"- name: DATABASE_SERVER\n  value: YOUR_NEW_IP_HERE\n"})}),"\n",(0,a.jsx)(n.p,{children:"Then we can deploy the application with the information it needs to find its database.  We'll also list out our pods to see what is running."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl apply -f ./manifests/pod-app.yaml\nkubectl get pods\n"})}),"\n",(0,a.jsx)(n.p,{children:"Feel free to look back and use the port forwarding trick to make sure your app is running if you'd like."}),"\n",(0,a.jsx)(n.h4,{id:"knocking-it-down",children:"Knocking It Down"}),"\n",(0,a.jsx)(n.p,{children:"The first thing we'll try to break is our application pod.  Let's delete it."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl delete pod azure-voting-app\n"})}),"\n",(0,a.jsx)(n.p,{children:"Then, we'll check our pod's status:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl get pods\n"})}),"\n",(0,a.jsx)(n.p,{children:"Which should show something like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"azure-voting-app-rust \u276f  kubectl get pods\nNAME              READY   STATUS    RESTARTS   AGE\nazure-voting-db   1/1     Running   0          50s\n"})}),"\n",(0,a.jsx)(n.p,{children:"We should be able to recreate our application pod deployment with no problem, since it has the current database IP address and nothing else depends on it."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl apply -f ./manifests/pod-app.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"Again, feel free to do some fun port forwarding and check your site is running."}),"\n",(0,a.jsx)(n.h4,{id:"uncomfortable-truths",children:"Uncomfortable Truths"}),"\n",(0,a.jsx)(n.p,{children:"Here's where it gets a bit stickier, what if we delete the database container?"}),"\n",(0,a.jsx)(n.p,{children:"If we delete our database container and recreate it, it'll likely have a new IP address, which would force us to update our application configuration.  We'll look at some solutions for these problems in the next three posts this week."}),"\n",(0,a.jsx)(n.p,{children:"Because our database problem is a bit tricky, we'll primarily focus on making our application layer more resilient and prepare our database layer for those other techniques over the next few days."}),"\n",(0,a.jsx)(n.p,{children:"Let's clean back up and look into making things more resilient."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl delete -f ./manifests/pod-app.yaml\nkubectl delete -f ./manifests/pod-db.yaml\n"})}),"\n",(0,a.jsx)(n.h3,{id:"the-deployment",children:"The Deployment"}),"\n",(0,a.jsx)(n.p,{children:"One of the reasons you may want to use Kubernetes is it's ability to orchestrate workloads.  Part of that orchestration includes being able to ensure that certain workloads are running (regardless of what Node they might be on)."}),"\n",(0,a.jsxs)(n.p,{children:["We saw that we could delete our application pod and then restart it from the manifest with little problem.  It just meant that we had to run a command to restart it.  We can use the ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/concepts-clusters-workloads?WT.mc_id=containers-84290-stmuraws#deployments-and-yaml-manifests",children:"Deployment"})," in Kubernetes to tell the orchestrator to ensure we have our application pod running."]}),"\n",(0,a.jsx)(n.p,{children:"The Deployment also can encompass a lot of extra configuration - controlling how many containers of a particular type should be running, how upgrades of container images should proceed, and more."}),"\n",(0,a.jsx)(n.h4,{id:"creating-the-deployment",children:"Creating the Deployment"}),"\n",(0,a.jsx)(n.p,{children:"First, we'll create a Deployment for our database. We'll use a technique similar to what we did for the Pod, with just a bit of difference."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:'kubectl create deployment azure-voting-db `\n                            --image "postgres:15.0-alpine" `\n                            --port 5432 `\n                            --output yaml `\n                            --dry-run=client > manifests/deployment-db.yaml\n'})}),"\n",(0,a.jsx)(n.p,{children:"Unlike our Pod definition creation, we can't pass in environment variable configuration from the command line.  We'll have to edit the YAML file to add that."}),"\n",(0,a.jsxs)(n.p,{children:["So, let's open ",(0,a.jsx)(n.code,{children:"./manifests/deployment-db.yaml"})," in our editor and add the following in the ",(0,a.jsx)(n.code,{children:"spec/containers"})," configuration."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yml",children:'        env:\n        - name: POSTGRES_PASSWORD\n          value: "mypassword"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Your file should look like this ",(0,a.jsx)(n.a,{href:"https://github.com/azure-samples/azure-voting-app-rust/blob/week2/day1/manifests/deployment-db.yaml",children:"deployment-db.yaml"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Once we have our configuration file updated, we can deploy our database container image."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl apply -f ./manifests/deployment-db.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"For our application, we'll use the same technique."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:'kubectl create deployment azure-voting-app `\n                        --image "$AcrName.azurecr.io/cnny2023/azure-voting-app-rust:$BuildTag" `\n                        --port 8080 `\n                        --output yaml `\n                        --dry-run=client > manifests/deployment-app.yaml\n'})}),"\n",(0,a.jsx)(n.p,{children:"Next, we'll need to add an environment variable to the generated configuration.  We'll also need the new IP address for the database deployment."}),"\n",(0,a.jsxs)(n.p,{children:["Previously, we named the pod and were able to ask for the IP address with ",(0,a.jsx)(n.code,{children:"kubectl"})," and a bit of JSONPath. Now, the deployment created the pod for us, so there's a bit of random in the naming.  Check out:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl get pods\n"})}),"\n",(0,a.jsx)(n.p,{children:"Should return something like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"azure-voting-app-rust \u276f  kubectl get pods\nNAME                               READY   STATUS    RESTARTS   AGE\nazure-voting-db-686d758fbf-8jnq8   1/1     Running   0          7s\n"})}),"\n",(0,a.jsxs)(n.p,{children:["We can either ask for the IP with the new pod name, or we can use a ",(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors",children:"selector"})," to find our desired pod."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl get pod --selector app=azure-voting-db -o jsonpath='{.items[0].status.podIP}'\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now, we can update our application deployment configuration file with:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yml",children:"        env:\n        - name: DATABASE_SERVER\n          value: YOUR_NEW_IP_HERE\n        - name: DATABASE_PASSWORD\n          value: mypassword\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Your file should look like this ",(0,a.jsx)(n.a,{href:"https://github.com/azure-samples/azure-voting-app-rust/blob/week2/day1/manifests/deployment-app.yaml",children:"deployment-app.yaml"})," (but with IPs and image names matching your environment)."]}),"\n",(0,a.jsx)(n.p,{children:"After we save those changes, we can deploy our application."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl apply -f ./manifests/deployment-app.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"Let's test the resilience of our app now. First, we'll delete the pod running our application, then we'll check to make sure Kubernetes restarted our application pod."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl get pods\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"azure-voting-app-rust \u276f  kubectl get pods\nNAME                                READY   STATUS    RESTARTS   AGE\nazure-voting-app-56c9ccc89d-skv7x   1/1     Running   0          71s\nazure-voting-db-686d758fbf-8jnq8    1/1     Running   0          12m\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl delete pod azure-voting-app-56c9ccc89d-skv7x\nkubectl get pods\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'azure-voting-app-rust \u276f  kubectl delete pod azure-voting-app-56c9ccc89d-skv7x\n>> kubectl get pods\npod "azure-voting-app-56c9ccc89d-skv7x" deleted\nNAME                                READY   STATUS    RESTARTS   AGE\nazure-voting-app-56c9ccc89d-2b5mx   1/1     Running   0          2s\nazure-voting-db-686d758fbf-8jnq8    1/1     Running   0          14m\n'})}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsx)(n.p,{children:"Your Pods will likely have different identifiers at the end, so adjust your commands to match the names in your environment."})}),"\n",(0,a.jsxs)(n.p,{children:["As you can see, by the time the ",(0,a.jsx)(n.code,{children:"kubectl get pods"})," command was run, Kubernetes had already spun up a new pod for the application container image.  Thanks Kubernetes!"]}),"\n",(0,a.jsx)(n.h3,{id:"clean-up-1",children:"Clean up"}),"\n",(0,a.jsx)(n.p,{children:"Since we can't just delete the pods, we have to delete the deployments."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-powershell",children:"kubectl delete -f ./manifests/deployment-app.yaml\nkubectl delete -f ./manifests/deployment-db.yaml\n"})}),"\n",(0,a.jsx)(n.h3,{id:"summary---deployments",children:"Summary - Deployments"}),"\n",(0,a.jsx)(n.p,{children:"Deployments allow us to create more durable configuration for the workloads we deploy into Kubernetes. As we dig deeper, we'll discover more capabilities the deployments offer. Check out the Resources below for more."}),"\n",(0,a.jsx)(n.h2,{id:"exercise",children:"Exercise"}),"\n",(0,a.jsxs)(n.p,{children:["If you want to try these steps, head over to ",(0,a.jsx)(n.a,{href:"https://aka.ms/azure-voting-app-rust",children:"the source repository"}),", fork it, clone it locally, and give it a spin!"]}),"\n",(0,a.jsxs)(n.p,{children:["You can check your manifests against the manifests in the ",(0,a.jsx)(n.code,{children:"week2/day1"})," ",(0,a.jsx)(n.a,{href:"https://github.com/azure-samples/azure-voting-app-rust/tree/week2/day1/manifests",children:"branch of the source repository"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,a.jsxs)(n.admonition,{title:"Take the Cloud Skills Challenge!",type:"tip",children:[(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/training/challenges?id=a0e385b9-f970-4182-b2e2-3b4619b6c356",children:"Enroll"})," in the Cloud Skills Challenge!"]}),(0,a.jsx)(n.p,{children:"Don't miss out on this opportunity to level up your skills and stay ahead of the curve in the world of cloud native."})]}),"\n",(0,a.jsx)(n.h3,{id:"documentation",children:"Documentation"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=containers-84290-stmuraws",children:"Azure Kubernetes Service"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/azure-resource-manager/bicep/overview?WT.mc_id=containers-84290-stmuraws&tabs=bicep",children:"Bicep"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://aka.ms/azure-voting-app-rust",children:"Azure Voting App in Rust"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/concepts-clusters-workloads?WT.mc_id=containers-84290-stmuraws#pods",children:"Pods"}),"."]}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/concepts-clusters-workloads?WT.mc_id=containers-84290-stmuraws#nodes-and-node-pools",children:"Nodes"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/kubectl/kubectl/",children:"kubectl"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/kubectl/jsonpath/",children:"JSONPath syntax"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/concepts-clusters-workloads?WT.mc_id=containers-84290-stmuraws#deployments-and-yaml-manifests",children:"Deployment"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors",children:"Labels and Selectors"})}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"training",children:"Training"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/training/paths/intro-to-kubernetes-on-azure/?WT.mc_id=containers-84290-stmuraws",children:"Learning Path - Introduction to Kubernetes on Azure"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},31506:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/azure_voting_app-f23e02d61834bad88440b2aab40012fb.png"},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>i});var a=t(67294);const s={},o=a.createContext(s);function i(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);