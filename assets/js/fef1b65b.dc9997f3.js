"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[57316],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=i,g=c["".concat(s,".").concat(m)]||c[m]||u[m]||r;return n?a.createElement(g,o(o({ref:t},d),{},{components:n})):a.createElement(g,o({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},61411:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(87462),i=(n(67294),n(3905));const r={date:"2023-09-28T09:01",slug:"powering-intelligent-apps-with-azure-cosmos-db-2",title:"2-4. Powering Intelligent Apps with Azure Cosmos DB (2)",authors:["cnteam"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["Cloud","Data","AI","AI/ML","intelligent apps","cloud-native","30-days","enterprise apps","digital experiences","app modernization","serverless","ai apps","data"],image:"https://azure.github.io/Cloud-Native/img/ogImage.png",description:"Explore the power of multi-model databases for Intelligent Apps and their integration with Azure Cosmos DB and Azure Kubernetes Service (AKS).",tags:["Fall-For-IA","30-days-of-IA","learn-live","hack-together","community-buzz","ask-the-expert","azure-kubernetes-service","azure-functions","azure-openai","azure-container-apps","azure-cosmos-db","github-copilot","github-codespaces","github-actions"]},o=void 0,l={permalink:"/Cloud-Native/30DaysOfIA/powering-intelligent-apps-with-azure-cosmos-db-2",source:"@site/blog-30daysofIA/2023-09-28/powering-intelligent-apps-with-azure-cosmos-db-2.md",title:"2-4. Powering Intelligent Apps with Azure Cosmos DB (2)",description:"Explore the power of multi-model databases for Intelligent Apps and their integration with Azure Cosmos DB and Azure Kubernetes Service (AKS).",date:"2023-09-28T09:01:00.000Z",formattedDate:"September 28, 2023",tags:[{label:"Fall-For-IA",permalink:"/Cloud-Native/30DaysOfIA/tags/fall-for-ia"},{label:"30-days-of-IA",permalink:"/Cloud-Native/30DaysOfIA/tags/30-days-of-ia"},{label:"learn-live",permalink:"/Cloud-Native/30DaysOfIA/tags/learn-live"},{label:"hack-together",permalink:"/Cloud-Native/30DaysOfIA/tags/hack-together"},{label:"community-buzz",permalink:"/Cloud-Native/30DaysOfIA/tags/community-buzz"},{label:"ask-the-expert",permalink:"/Cloud-Native/30DaysOfIA/tags/ask-the-expert"},{label:"azure-kubernetes-service",permalink:"/Cloud-Native/30DaysOfIA/tags/azure-kubernetes-service"},{label:"azure-functions",permalink:"/Cloud-Native/30DaysOfIA/tags/azure-functions"},{label:"azure-openai",permalink:"/Cloud-Native/30DaysOfIA/tags/azure-openai"},{label:"azure-container-apps",permalink:"/Cloud-Native/30DaysOfIA/tags/azure-container-apps"},{label:"azure-cosmos-db",permalink:"/Cloud-Native/30DaysOfIA/tags/azure-cosmos-db"},{label:"github-copilot",permalink:"/Cloud-Native/30DaysOfIA/tags/github-copilot"},{label:"github-codespaces",permalink:"/Cloud-Native/30DaysOfIA/tags/github-codespaces"},{label:"github-actions",permalink:"/Cloud-Native/30DaysOfIA/tags/github-actions"}],readingTime:13.695,hasTruncateMarker:!1,authors:[{name:"It's 30DaysOfIA",title:"FallForIA Content Team",url:"https://azure.github.io/Cloud-Native/Fall-For-IA/",imageURL:"https://azure.github.io/Cloud-Native/img/logo-ms-cloud-native.png",key:"cnteam"}],frontMatter:{date:"2023-09-28T09:01",slug:"powering-intelligent-apps-with-azure-cosmos-db-2",title:"2-4. Powering Intelligent Apps with Azure Cosmos DB (2)",authors:["cnteam"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["Cloud","Data","AI","AI/ML","intelligent apps","cloud-native","30-days","enterprise apps","digital experiences","app modernization","serverless","ai apps","data"],image:"https://azure.github.io/Cloud-Native/img/ogImage.png",description:"Explore the power of multi-model databases for Intelligent Apps and their integration with Azure Cosmos DB and Azure Kubernetes Service (AKS).",tags:["Fall-For-IA","30-days-of-IA","learn-live","hack-together","community-buzz","ask-the-expert","azure-kubernetes-service","azure-functions","azure-openai","azure-container-apps","azure-cosmos-db","github-copilot","github-codespaces","github-actions"]},nextItem:{title:"2-3. Powering Intelligent Apps with Azure Cosmos DB (1)",permalink:"/Cloud-Native/30DaysOfIA/powering-intelligent-apps-with-azure-cosmos-db-1"}},s={authorsImageUrls:[void 0]},p=[{value:"What We&#39;ll Cover:",id:"what-well-cover",level:2},{value:"Powering Intelligent Apps with a Multi-Model Database Using Cosmos DB and Azure Kubernetes Service (2) \u202f",id:"powering-intelligent-apps-with-a-multi-model-database-using-cosmos-db-and-azure-kubernetes-service-2-",level:2},{value:"Loading OCR Data into the Multi-Model Database",id:"loading-ocr-data-into-the-multi-model-database",level:2},{value:"Configuring the Intelligent App to Use Cosmos DB",id:"configuring-the-intelligent-app-to-use-cosmos-db",level:3},{value:"Diverse Data and Cosmos DB: A Perfect Match",id:"diverse-data-and-cosmos-db-a-perfect-match",level:3},{value:"Implementing the CosmosDBHelper Class",id:"implementing-the-cosmosdbhelper-class",level:3},{value:"Introducing New OCR Helper Functions",id:"introducing-new-ocr-helper-functions",level:3},{value:"Testing the Intelligent App Locally",id:"testing-the-intelligent-app-locally",level:2},{value:"Updating the Version of the Intelligent App on AKS",id:"updating-the-version-of-the-intelligent-app-on-aks",level:2},{value:"Checking the Results in Azure Cosmos DB",id:"checking-the-results-in-azure-cosmos-db",level:3},{value:"Exploring Real-World Use Cases for Multi-Model Databases",id:"exploring-real-world-use-cases-for-multi-model-databases",level:2},{value:"Exercise",id:"exercise",level:2},{value:"Next Steps",id:"next-steps",level:2}],d={toc:p};function u(e){let{components:t,...r}=e;return(0,i.kt)("wrapper",(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("head",null,(0,i.kt)("meta",{property:"og:url",content:"https://azure.github.io/cloud-native/30daysofia/powering-intelligent-apps-with-azure-cosmos-db-2"}),(0,i.kt)("meta",{property:"og:type",content:"website"}),(0,i.kt)("meta",{property:"og:title",content:"**Fall For Intelligent Apps! \ud83c\udf42| Build AI Apps On Azure"}),(0,i.kt)("meta",{property:"og:description",content:"Explore the power of multi-model databases for Intelligent Apps and their integration with Azure Cosmos DB and Azure Kubernetes Service (AKS)."}),(0,i.kt)("meta",{property:"og:image",content:"https://azure.github.io/Cloud-Native/img/ogImage.png"}),(0,i.kt)("meta",{name:"twitter:url",content:"https://azure.github.io/Cloud-Native/30daysofIA/powering-intelligent-apps-with-azure-cosmos-db-2"}),(0,i.kt)("meta",{name:"twitter:title",content:"**Fall For Intelligent Apps! \ud83c\udf42 | Build AI Apps On Azure"}),(0,i.kt)("meta",{name:"twitter:description",content:"2-4. Explore the power of multi-model databases for Intelligent Apps and their integration with Azure Cosmos DB and Azure Kubernetes Service (AKS)"}),(0,i.kt)("meta",{name:"twitter:image",content:"https://azure.github.io/Cloud-Native/img/ogImage.png"}),(0,i.kt)("meta",{name:"twitter:card",content:"summary_large_image"}),(0,i.kt)("meta",{name:"twitter:creator",content:"@devanshidiaries"}),(0,i.kt)("meta",{name:"twitter:site",content:"@AzureAdvocates"}),(0,i.kt)("link",{rel:"canonical",href:"https://azure.github.io/Cloud-Native/30daysofIA/powering-intelligent-apps-with-azure-cosmos-db-2"})),(0,i.kt)("p",null,"In this article, continue to explore the power of multi-model databases for Intelligent Apps and their integration with Azure Cosmos DB and Azure Kubernetes Service (AKS)."),(0,i.kt)("h2",{id:"what-well-cover"},"What We'll Cover:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Loading OCR Data into the Multi-Model Database"),(0,i.kt)("li",{parentName:"ul"},"Configuring the Intelligent App to Use Cosmos DB"),(0,i.kt)("li",{parentName:"ul"},"Testing the app locally and deploying to AKS")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image of a multi-model database",src:n(1644).Z,width:"624",height:"380"})),(0,i.kt)("h2",{id:"powering-intelligent-apps-with-a-multi-model-database-using-cosmos-db-and-azure-kubernetes-service-2-"},"Powering Intelligent Apps with a Multi-Model Database Using Cosmos DB and Azure Kubernetes Service (2) \u202f"),(0,i.kt)("p",null,"In the ",(0,i.kt)("a",{parentName:"p",href:"https://azure.github.io/Cloud-Native/30daysofIA/build-your-first-intelligent-app-with-azure-ai-and-aks-1"},"first article of this week"),", we created an Intelligent App that helped us analyze images and extract valuable data. We constructed a Python web API to execute ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/azure/ai-services/computer-vision/overview-ocr?WT.mc_id=javascript-99907-ninarasi"},"optical character recognition")," (OCR) on images uploaded to the application using ",(0,i.kt)("a",{parentName:"p",href:"https://azure.microsoft.com/products/cognitive-services/vision-services?WT.mc_id=javascript-99907-ninarasi"},"Azure AI Vision")," and ",(0,i.kt)("a",{parentName:"p",href:"https://azure.microsoft.com/products/kubernetes-service?WT.mc_id=javascript-99907-ninarasi"},"Azure Kubernetes Service")," (AKS) for hosting the application."),(0,i.kt)("p",null,"In continuation of the ",(0,i.kt)("a",{parentName:"p",href:"https://azure.github.io/Cloud-Native/30daysofIA/powering-intelligent-apps-with-azure-cosmos-db-1"},"previous article"),", we\u2019ll continue to explore how Azure Cosmos DB\u2019s support for multi-model databases provides flexibility in data modeling, scalability, and performance optimization\u2014crucial for storing, indexing, and querying data in multiple formats."),(0,i.kt)("h2",{id:"loading-ocr-data-into-the-multi-model-database"},"Loading OCR Data into the Multi-Model Database"),(0,i.kt)("p",null,"Once we\u2019ve created our Cosmos DB account and configured our containers, we can access them using the Azure Cosmos DB API with the appropriate host URI and key. You can find these credentials by selecting ",(0,i.kt)("strong",{parentName:"p"},"Keys")," on the sidebar, like in the image below:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image of selecting Keys in sidebar of Cosmos DB account",src:n(72934).Z,width:"624",height:"544"})),(0,i.kt)("h3",{id:"configuring-the-intelligent-app-to-use-cosmos-db"},"Configuring the Intelligent App to Use Cosmos DB"),(0,i.kt)("p",null,"Now, we must provide the app with our Cosmos DB database credentials. We\u2019ll do this using the environment variables in the deployment configuration file created in the first part of this series."),(0,i.kt)("p",null,"Open the ",(0,i.kt)("inlineCode",{parentName:"p"},"deployment.yml")," file (in the ",(0,i.kt)("inlineCode",{parentName:"p"},"Deployment")," folder) and add the following environment variables matching your Cosmos DB account information:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"- name: COSMOS_ACCOUNT_CONNECTION_STRING\n  value: <YOUR-COSMOS-ACCOUNT-PRIMARY-CONNECTION-STRING>\n- name: COSMOS_ACCOUNT_HOST\n  value: <YOUR-COSMOS-ACCOUNT-URI>\n- name: COSMOS_ACCOUNT_KEY\n  value: <YOUR-COSMOS-ACCOUNT-PRIMARY-KEY>\n- name: COSMOS_DATABASE_ID\n  value: IntelligentAppDB\n- name: COSMOS_IMAGE_ANALYSIS_CONTAINER_ID\n  value: ImageAnalysisContainer\n- name: COSMOS_AGGREGATE_RESULTS_CONTAINER_ID\n  value: AggregateResultsContainer\n")),(0,i.kt)("p",null,"Then, open the ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," file and add the following environment variables, copying the same values you defined above:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"      - COSMOS_ACCOUNT_CONNECTION_STRING=<YOUR-COSMOS-ACCOUNT-PRIMARY-CONNECTION-STRING> \n      - COSMOS_ACCOUNT_HOST=<YOUR-COSMOS-ACCOUNT-URI> \n      - COSMOS_ACCOUNT_KEY=<YOUR-COSMOS-ACCOUNT-PRIMARY-KEY> \n      - COSMOS_DATABASE_ID=IntelligentAppDB \n      - COSMOS_IMAGE_ANALYSIS_CONTAINER_ID=ImageAnalysisContainer \n      - COSMOS_AGGREGATE_RESULTS_CONTAINER_ID=AggregateResultsContainer\n")),(0,i.kt)("h3",{id:"diverse-data-and-cosmos-db-a-perfect-match"},"Diverse Data and Cosmos DB: A Perfect Match"),(0,i.kt)("p",null,"The diverse and often unstructured nature of OCR data finds an ideal match in the flexible structure of a multi-model database like Azure Cosmos DB for NoSQL. OCR data frequently encompasses many document types, varying layouts, languages, and formatting styles, making it inherently challenging to impose a rigid schema."),(0,i.kt)("p",null,"The picture below represents the varying data layouts we\u2019ll encounter in this article. The left-hand picture shows ",(0,i.kt)("strong",{parentName:"p"},"Data from OCR analysis"),", which contains AI-generated descriptions of the image, plus the characters read and their positions within it. The right-hand picture shows ",(0,i.kt)("strong",{parentName:"p"},"Data from aggregation"),"\u2014the numeric operations performed on the numbers read."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image of selecting Keys in sidebar of Cosmos DB account",src:n(60438).Z,width:"624",height:"282"})),(0,i.kt)("h3",{id:"implementing-the-cosmosdbhelper-class"},"Implementing the CosmosDBHelper Class"),(0,i.kt)("p",null,"We need a Python class to provide a convenient way to interact with our Azure Cosmos DB service. It will encapsulate the necessary operations for creating and managing documents within the ",(0,i.kt)("inlineCode",{parentName:"p"},"ImageAnalysisContainer")," and the ",(0,i.kt)("inlineCode",{parentName:"p"},"AggregateResultsContainer"),"."),(0,i.kt)("p",null,"Let\u2019s create a file named ",(0,i.kt)("inlineCode",{parentName:"p"},"CosmosDBHelper.py")," in the project root folder with the following contents:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'import os \nimport azure.cosmos.cosmos_client as cosmos_client \n\nclass CosmosDBHelper: \n\n  def __init__(self):\n    self.cosmos_database_id = os.environ["COSMOS_DATABASE_ID"]\n    self.cosmos_image_analysis_container_id = os.environ["COSMOS_IMAGE_ANALYSIS_CONTAINER_ID"]\n    self.cosmos_aggregate_results_container_id = os.environ["COSMOS_AGGREGATE_RESULTS_CONTAINER_ID"]\n    cosmos_account_host = os.environ["COSMOS_ACCOUNT_HOST"]\n    cosmos_account_key = os.environ["COSMOS_ACCOUNT_KEY"]\n    self.client = cosmos_client.CosmosClient(cosmos_account_host, {\'masterKey\': cosmos_account_key})\n\u202f \n  def create_analysis(self, document):\n    db = self.client.get_database_client(self.cosmos_database_id)\n    container = db.get_container_client(self.cosmos_image_analysis_container_id)\n    return container.upsert_item(document)\n\n  def create_aggregate_result(self, inserted_id, aggregate_result):\n    db = self.client.get_database_client(self.cosmos_database_id)\n    container = db.get_container_client(self.cosmos_aggregate_results_container_id)\n    entity = {\n      "id": inserted_id,\n      "sum": float(aggregate_result["sum"]),\n      "average": float(aggregate_result["average"]),\n      "median": float(aggregate_result["median"]),\n      "min": float(aggregate_result["min"]),\n      "max": float(aggregate_result["max"])\n    }\n    return container.upsert_item(entity)\n')),(0,i.kt)("p",null,"Let's break down the code step by step, detailing the process of transferring the OCR-extracted data into the Cosmos DB database."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"azure.cosmos.cosmos_client")," module imported at the beginning of the file represents the Azure Cosmos DB for NoSQL client library for Python. We use it to interact with the Azure Cosmos DB service."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"CosmosDBHelper")," class constructor initializes the class instance and retrieves configuration values from the environment variables we configured in the previous section:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"COSMOS_DATABASE_ID"),"\u2014The ID of the Cosmos DB database"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"COSMOS_IMAGE_ANALYSIS_CONTAINER_ID"),"\u2014The ID of the container for storing image analysis documents"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"COSMOS_AGGREGATE_RESULTS_CONTAINER_ID"),"\u2014The ID of the container for storing aggregate result documents"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"COSMOS_ACCOUNT_HOST"),"\u2014The host URL for the Cosmos DB account"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"COSMOS_ACCOUNT_KEY"),"\u2014The authentication key for the Cosmos DB account")),(0,i.kt)("p",null,"The class constructor also creates a ",(0,i.kt)("inlineCode",{parentName:"p"},"CosmosClient")," instance using the provided account host and key, which we\u2019ll use in the methods below:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"create_analysis")," method inserts or updates an image analysis document into the ",(0,i.kt)("inlineCode",{parentName:"p"},"ImageAnalysisContainer")," container. It takes the document parameter, which represents the structured analysis data, to be inserted or updated. This method first fetches the database client using the provided database ID and the previously created Cosmos Client instance. Then, it fetches the container client for image analysis using the provided container ID. Finally, the ",(0,i.kt)("inlineCode",{parentName:"p"},"create_analysis")," method calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert_item")," method on the container client to insert or update the supplied document.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"create_aggregate_result")," method inserts or updates an aggregate result document into the specified container. It takes two arguments: ",(0,i.kt)("inlineCode",{parentName:"p"},"inserted_id")," (the document\u2019s ID) and ",(0,i.kt)("inlineCode",{parentName:"p"},"aggregate_result")," (a dictionary containing aggregated data like sum, average, median, min, and max). Similarly to the previous method, it fetches the database and container clients. Finally, the ",(0,i.kt)("inlineCode",{parentName:"p"},"create_aggregate_result")," constructs an entity dictionary with the provided data and uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"upsert_item")," method to insert or update the entity in the ",(0,i.kt)("inlineCode",{parentName:"p"},"AggregateResultsContainer")," container."))),(0,i.kt)("h3",{id:"introducing-new-ocr-helper-functions"},"Introducing New OCR Helper Functions"),(0,i.kt)("p",null,"We need some additional Python functions to process and insert image analysis results into a Cosmos DB using the CosmosDBHelper class from the previous explanation. First, open the ",(0,i.kt)("inlineCode",{parentName:"p"},"ocr_helper.py")," file from the first part of this series and add these import statements at the top of the file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"import json\nfrom CosmosDBHelper import CosmosDBHelper\n")),(0,i.kt)("p",null,"Next, locate these lines in the ",(0,i.kt)("inlineCode",{parentName:"p"},"ocr_helper.py")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"  ocr_result = get_ocr_result(result) \n  return ocr_result \n")),(0,i.kt)("p",null,"Replace these lines with:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'  ocr_result = get_ocr_result(result)\n  analysis_result = get_image_analysis_result(result, source_image)\n  ocr_result["analysis_result"] = analysis_result\n  inserted_id = insert_analysis(ocr_result["analysis_result"])\n  insert_aggregate_result(inserted_id, ocr_result["aggregate_result"])\n  return ocr_result\n')),(0,i.kt)("p",null,"Last, add the ",(0,i.kt)("inlineCode",{parentName:"p"},"get_image_analysis_result"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"insert_aggregate_result"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"insert_analysis")," functions: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'def get_image_analysis_result(result, source_image):\n\n  analysis_result = { }\n  string_list = []\n\n  if result.reason != sdk.ImageAnalysisResultReason.ANALYZED:\n    return sdk.ImageAnalysisErrorDetails.from_result(result)\n  else:\n\n    if result.caption is not None:\n        analysis_result["caption"] = {\n                                      "content": result.caption.content, \n                                      "confidence": result.caption.confidence \n                                      }        \n        analysis_result["text"] = {\n                                      "lines": []\n                                  }\n    if result.text is not None:\n      for line in result.text.lines:\n        line_result = {\n                        "content": line.content,\n                        "bounding_polygon": line.bounding_polygon,\n                        "words": [],\n                      }\n\n        for word in line.words:\n          word_result = {\n                          "content": word.content,\n                          "bounding_polygon": word.bounding_polygon,\n                          "confidence": word.confidence\n                        }\n          string_list.append(word.content)\n          line_result["words"].append(word_result)\n\n        document_id = os.path.basename(source_image).rsplit(\'.\', 1)[0]\n\n        analysis_result["file_name"] = source_image\n        analysis_result["text"]["lines"].append(line_result)\n        analysis_result["id"] = document_id\n        analysis_result["partitionKey"] = "Partition1"\n\n      return analysis_result\n\ndef insert_aggregate_result(inserted_id, aggregate_result):\n    db_helper = CosmosDBHelper()\n    db_helper.create_aggregate_result(inserted_id, aggregate_result)\n\ndef insert_analysis(analysis_result):\n    db_helper = CosmosDBHelper()\n    doc = db_helper.create_analysis(analysis_result)\n    return str(doc["id"])\n')),(0,i.kt)("p",null,"Let's examine each function step by step."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"get_image_analysis_result")," function takes two parameters: ",(0,i.kt)("inlineCode",{parentName:"p"},"result"),", an image analysis result object, and ",(0,i.kt)("inlineCode",{parentName:"p"},"source_image"),", the path to the source image. This function is responsible for the format transformation and data loading process: It creates an empty dictionary, ",(0,i.kt)("inlineCode",{parentName:"p"},"analysis_result"),", and an empty list, ",(0,i.kt)("inlineCode",{parentName:"p"},"string_list"),", to store words extracted from the text analysis. It checks if the ",(0,i.kt)("inlineCode",{parentName:"p"},"reason")," attribute of the result indicates that the image has been successfully analyzed (not an error). The function iterates through each line in ",(0,i.kt)("inlineCode",{parentName:"p"},"result.text.lines")," and processes the line\u2019s content, bounding polygon, and words. In the end, the function returns the populated analysis_result dictionary.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"insert_aggregate_result")," function takes two parameters: ",(0,i.kt)("inlineCode",{parentName:"p"},"inserted_id"),", the ID of the inserted document, and aggregate_result, a dictionary containing aggregated analysis results (sum, average, median, min, max). It initializes an instance of the ",(0,i.kt)("inlineCode",{parentName:"p"},"CosmosDBHelper")," class called ",(0,i.kt)("inlineCode",{parentName:"p"},"db_helper"),". It calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"create_aggregate_result")," method of ",(0,i.kt)("inlineCode",{parentName:"p"},"db_helper")," to insert the provided ",(0,i.kt)("inlineCode",{parentName:"p"},"aggregate_result")," into the ",(0,i.kt)("inlineCode",{parentName:"p"},"AggregateResultsContainer")," container.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"insert_analysis")," function takes one parameter: ",(0,i.kt)("inlineCode",{parentName:"p"},"analysis_result"),", a dictionary containing the image analysis results. It initializes an instance of the ",(0,i.kt)("inlineCode",{parentName:"p"},"CosmosDBHelper")," class called ",(0,i.kt)("inlineCode",{parentName:"p"},"db_helper"),". It then calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"create_analysis")," method of db_helper to insert the provided ",(0,i.kt)("inlineCode",{parentName:"p"},"analysis_result")," into the Analysis Results container. The ID of the inserted document is retrieved from the returned document and converted to a string before being returned from the function."))),(0,i.kt)("p",null,"The steps above highlight how the diverse and unstructured nature of OCR data, which we obtained from the Azure AI for Vision configured in the first article of this series, fits well with the flexible structure of a multi-model database."),(0,i.kt)("p",null,"Now, open your terminal and run the command below to reinstall all the packages added in the first part of this series:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"pip install -r requirements.txt")),(0,i.kt)("p",null,"Then, run the following commands to install the packages related to Azure Cosmos DB:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"pip install azure-cosmos\npip install azure-data-tables\n")),(0,i.kt)("p",null,"Finally, update the ",(0,i.kt)("inlineCode",{parentName:"p"},"requirements.txt")," file with the current package list:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"pip freeze > requirements.txt")),(0,i.kt)("h2",{id:"testing-the-intelligent-app-locally"},"Testing the Intelligent App Locally"),(0,i.kt)("p",null,"As in Part 1 of this series, run the following command in the terminal to build the image and start a container for the Intelligent App services defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"docker-compose up --build --force-recreate\n")),(0,i.kt)("p",null,"To test the API, open Postman and provide the fields as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"URL"),": http://localhost:5000/"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Method"),": POST"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Body"),":",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Form-data"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Key"),": file\u2014Click the right end of the ",(0,i.kt)("strong",{parentName:"li"},"Key")," field and select \u201cFile\u201d from the dropdown list."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Value"),": Click ",(0,i.kt)("strong",{parentName:"li"},"Select Files"),", then select the ",(0,i.kt)("strong",{parentName:"li"},"sample1.png")," file provided in the sample code.")))))),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image of test in localhost",src:n(81368).Z,width:"624",height:"169"})),(0,i.kt)("p",null,"Now click the ",(0,i.kt)("strong",{parentName:"p"},"Send")," button and review the result in ",(0,i.kt)("strong",{parentName:"p"},"Body"),":"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},'"{\\"aggregate_result\\": {\\"sum\\": \\"25821\\", \\"average\\": \\"5164.2\\", \\"median\\": \\"5622\\", \\"min\\": \\"1447\\", \\"max\\": \\"9802\\"}, \\"numbers_read\\": [\\"3049\\", \\"5901\\", \\"5622\\", \\"1447\\", \\"9802\\"], \\"analysis_result\\": {\\"caption\\": {\\"content\\": \\"a yellow rectangular sign with black numbers\\", \\"confidence\\": 0.7065904140472412}, \\"text\\": {\\"lines\\": [{\\"content\\": \\"3049\\", \\"bounding_polygon\\": [69.0, 14.0, 144.0, 13.0, 143.0, 38.0, 70.0, 39.0], \\"words\\": [{\\"content\\": \\"3049\\", \\"bounding_polygon\\": [69.0, 14.0, 139.0, 13.0, 140.0, 38.0, 69.0, 39.0], \\"confidence\\": 0.991}]}, {\\"content\\": \\"5901\\", \\"bounding_polygon\\": [70.0, 54.0, 142.0, 54.0, 141.0, 78.0, 70.0, 79.0], \\"words\\": [{\\"content\\": \\"5901\\", \\"bounding_polygon\\": [70.0, 54.0, 139.0, 54.0, 139.0, 79.0, 70.0, 79.0], \\"confidence\\": 0.995}]}, {\\"content\\": \\"5622\\", \\"bounding_polygon\\": [70.0, 94.0, 143.0, 94.0, 142.0, 119.0, 69.0, 119.0], \\"words\\": [{\\"content\\": \\"5622\\", \\"bounding_polygon\\": [69.0, 94.0, 140.0, 94.0, 140.0, 119.0, 69.0, 119.0], \\"confidence\\": 0.998}]}, {\\"content\\": \\"1447\\", \\"bounding_polygon\\": [69.0, 136.0, 144.0, 136.0, 144.0, 161.0, 69.0, 161.0], \\"words\\": [{\\"content\\": \\"1447\\", \\"bounding_polygon\\": [70.0, 137.0, 140.0, 137.0, 139.0, 161.0, 70.0, 161.0], \\"confidence\\": 0.998}]}, {\\"content\\": \\"9802\\", \\"bounding_polygon\\": [69.0, 176.0, 142.0, 176.0, 143.0, 202.0, 69.0, 202.0], \\"words\\": [{\\"content\\": \\"9802\\", \\"bounding_polygon\\": [69.0, 176.0, 141.0, 176.0, 141.0, 202.0, 69.0, 202.0], \\"confidence\\": 0.998}]}]}, \\"file_name\\": \\"static/files/sample1.png\\", \\"id\\": \\"sample1\\", \\"partitionKey\\": \\"Partition1\\"}}"')),(0,i.kt)("p",null,"As we can see, the app running on a local container returned the correct JSON containing the analysis results and aggregate results based on the sample image."),(0,i.kt)("h2",{id:"updating-the-version-of-the-intelligent-app-on-aks"},"Updating the Version of the Intelligent App on AKS"),(0,i.kt)("p",null,"Now that we\u2019ve learned how to implement and test the new Cosmos DB-powered app version locally, let\u2019s explore how to update and deploy this new version of our Intelligent App in AKS using Docker and Kubernetes command-line tools. This process ensures that the latest version of the application is deployed and running in the Kubernetes cluster."),(0,i.kt)("h3",{id:"checking-the-results-in-azure-cosmos-db"},"Checking the Results in Azure Cosmos DB"),(0,i.kt)("p",null,"Now, it\u2019s time to see how the results were stored in the Azure Cosmos DB for NoSQL multi-model database. "),(0,i.kt)("p",null,"In the Azure Portal, open your Cosmos DB account resource, click the ",(0,i.kt)("strong",{parentName:"p"},"Data Explorer")," tab, expand the IntelligentAppDB database tree, and click the ",(0,i.kt)("strong",{parentName:"p"},"Items")," node within the ",(0,i.kt)("strong",{parentName:"p"},"AggregateResultsContainer"),". Then click the ",(0,i.kt)("strong",{parentName:"p"},"sample1")," item to see the results on the right-side panel:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image of sample1 in Data Explorer tab",src:n(62755).Z,width:"624",height:"224"})),(0,i.kt)("p",null,"Now, click the ",(0,i.kt)("strong",{parentName:"p"},"Items")," node within the ",(0,i.kt)("strong",{parentName:"p"},"ImageAnalysisContainer")," and click the ",(0,i.kt)("strong",{parentName:"p"},"sample1")," item to see the results on the right-side panel:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image of sample1 in ImageAnalysisContainer",src:n(8226).Z,width:"624",height:"304"})),(0,i.kt)("p",null,"As we can see, our Intelligent App performs OCR operations that produce results in varied structures. However, through Azure Cosmos DB, we can store these structures effortlessly by separating items into containers without creating complex schemas for each data type."),(0,i.kt)("p",null,"Before creating version 2 of the app, ensure your Docker container is running. Then, run the following commands to stop and remove the local ",(0,i.kt)("inlineCode",{parentName:"p"},"intelligent-app")," container:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"docker container stop intelligent-app\ndocker container rm intelligent-app\n")),(0,i.kt)("p",null,"Then, to recreate the Intelligent App\u2019s image, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose app")," command below with the ",(0,i.kt)("inlineCode",{parentName:"p"},"--build")," argument:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"docker-compose up --build --force-recreate\n")),(0,i.kt)("p",null,"Now, use the docker ",(0,i.kt)("inlineCode",{parentName:"p"},"tag")," command to tag the image. Replace ",(0,i.kt)("inlineCode",{parentName:"p"},"<name-of-azure-container-registry>")," below with your ACR login server name or public registry hostname. Be sure to update the image version to ",(0,i.kt)("inlineCode",{parentName:"p"},":v2")," as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"docker tag intelligent-app <name-of-azure-container-registry>.azurecr.io/intelligent-app:v2\n")),(0,i.kt)("p",null,"Now, run the following command to show your container image with the new tags:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"docker images\n")),(0,i.kt)("p",null,"You\u2019ll get a result similar to the one below:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:"left"},"REPOSITORY"),(0,i.kt)("th",{parentName:"tr",align:"left"},"TAG"),(0,i.kt)("th",{parentName:"tr",align:"left"},"IMAGE ID"),(0,i.kt)("th",{parentName:"tr",align:"left"},"CREATED"),(0,i.kt)("th",{parentName:"tr",align:"left"},"SIZE"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},"intelligent-app"),(0,i.kt)("td",{parentName:"tr",align:"left"},"latest"),(0,i.kt)("td",{parentName:"tr",align:"left"},"1ca9eb914279"),(0,i.kt)("td",{parentName:"tr",align:"left"},"40 minutes ago"),(0,i.kt)("td",{parentName:"tr",align:"left"},"258MB")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},"<","name-of-azure-container-registry",">",".azurecr.io/intelligent-app"),(0,i.kt)("td",{parentName:"tr",align:"left"},"v2"),(0,i.kt)("td",{parentName:"tr",align:"left"},"1ca9eb914279"),(0,i.kt)("td",{parentName:"tr",align:"left"},"40 minutes ago"),(0,i.kt)("td",{parentName:"tr",align:"left"},"258MB")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},"<","name-of-azure-container-registry",">",".azurecr.io/intelligent-app"),(0,i.kt)("td",{parentName:"tr",align:"left"},"v1"),(0,i.kt)("td",{parentName:"tr",align:"left"},"676ede4aa18c"),(0,i.kt)("td",{parentName:"tr",align:"left"},"About an hour ago"),(0,i.kt)("td",{parentName:"tr",align:"left"},"197MB")))),(0,i.kt)("p",null,"Now, use ",(0,i.kt)("inlineCode",{parentName:"p"},"docker push")," to upload the image to your registry. Replace ",(0,i.kt)("inlineCode",{parentName:"p"},"<name-of-azure-container-registry>")," with your ACR login server name."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"docker push <name-of-azure-container-registry>.azurecr.io/intelligent-app:v2\n")),(0,i.kt)("p",null,"To update the application, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl")," set command. Update ",(0,i.kt)("inlineCode",{parentName:"p"},"<name-of-azure-container-registry>")," with the login server or hostname of your container registry, and specify the v2 application version:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"kubectl set image deployment intelligent-app intelligent-app=<name-of-azure-container-registry>.azurecr.io/intelligent-app:v2 \n")),(0,i.kt)("p",null,"Now, we\u2019ll deploy version 2 of our application using the kubectl command. First, change the terminal to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Deployment")," folder:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"cd Deployment\n")),(0,i.kt)("p",null,"Open the ",(0,i.kt)("inlineCode",{parentName:"p"},"deployment.yml")," file in an editor and update the container image version tag to v2:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"image: intelligentapp.azurecr.io/intelligent-app:v2\n")),(0,i.kt)("p",null,"Then, run the following command to create or update Kubernetes resources defined in the ",(0,i.kt)("inlineCode",{parentName:"p"},"deployment.yml")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"kubectl apply -f deployment.yml\n")),(0,i.kt)("h2",{id:"exploring-real-world-use-cases-for-multi-model-databases"},"Exploring Real-World Use Cases for Multi-Model Databases"),(0,i.kt)("p",null,"Numerous industries can benefit from leveraging multi-model databases when building Intelligent Apps. Below are just a few real-world examples:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"E-commerce personalization"),"\u2014Multi-model databases allow e-commerce platforms to store and manage various data types, such as customer profiles, product details, purchase history, and user-generated content like reviews and images."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Healthcare patient records"),"\u2014Multi-model databases can help manage diverse patient data in the healthcare sector, like diagnoses and medications, semi-structured data like doctors' notes, and unstructured data like medical images and test results."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Social media analytics"),"\u2014Multi-model databases find applications in social media platforms for handling the vast and varied data users generate, such as user profiles, connections, posts, images, videos, and textual content. The databases enable social platforms to execute quick and complex queries for real-time analytics."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Cosmos DB\u2019s schema"),"-agnostic approach helps it seamlessly adapt to this diversity, enabling our Intelligent App to store OCR analysis and aggregation data as JSON documents without predefined structures.")),(0,i.kt)("p",null,"Unlike traditional relational databases, the flexibility of a multi-model database like Cosmos DB for NoSQL ensures that the database can accommodate the ever-evolving OCR data without frequent schema modifications. This quality makes it a robust choice for our Intelligent App, which processes diverse documents and requires rapid adaptability."),(0,i.kt)("h2",{id:"exercise"},"Exercise"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Complete this ",(0,i.kt)("strong",{parentName:"li"},"hands-on sample")," ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/contentlab-io/Microsoft-Using-Azure-Kubernetes-Service-to-Deploy-an-Intelligent-App-for-Analyzing-Images-2/tree/main/Microsoft_Series_19-20_Code/intelligent-app-after-pt2"},"project code")," to build your intelligent app with multi-modal databases and AKS.\u202f "),(0,i.kt)("li",{parentName:"ul"},"Complete the ",(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("a",{parentName:"strong",href:"https://aka.ms/fallforIA/apps-csc"},"Apps Cloud Skills Challenge"))," to build on your app dev and AI skills.\u202f "),(0,i.kt)("li",{parentName:"ul"},"Register for ",(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("a",{parentName:"strong",href:"https://reactor.microsoft.com/reactor/series/S-1037/"},"Ask the Expert: Azure Kubernetes Service"))," session for live Q&A with the Product Engineering team on building intelligent serverless apps.")),(0,i.kt)("h2",{id:"next-steps"},"Next Steps"),(0,i.kt)("p",null,"Multi-model databases are invaluable for Intelligent Apps, offering intelligent indexing, caching, and query optimization for swift data access. They accommodate various data structures like documents, graphs, and key-value pairs, enabling cohesive data management, streamlined development, and insightful analysis\u2014promoting limitless scalability and letting us adapt data to numerous formats without compromising efficiency."),(0,i.kt)("p",null,"Discover ",(0,i.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/azure/architecture/data-guide/technology-choices/data-storage?WT.mc_id=javascript-99907-ninarasi#azure-cosmos-db"},"Azure\u2019s Cosmos DB and other services")," to unlock even more potential in your Intelligent Apps\u2014and carry on to the third and final topic of this week to learn how to take your Intelligent Apps to the next level with Azure Kubernetes Service in the next article."))}u.isMDXComponent=!0},1644:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/blog-image-4-1-63886f49574e526b8fbf4d7e333c89da.png"},72934:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/blog-image-4-2-7df307d73bcc223ef4cbfdd823f07ebb.png"},60438:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/blog-image-4-3-62d7f6ef9a34751d686a2c82c89557ed.png"},81368:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/blog-image-4-4-d7d7da014082737ce540ad6faa11a47f.png"},62755:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/blog-image-4-5-490f8f94e02a585b8363bc442fdef765.png"},8226:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/blog-image-4-6-a0c271c6870d15f0cf7b02051e98b806.png"}}]);