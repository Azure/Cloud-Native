"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[60303],{33610:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var i=t(85893),a=t(11151);const r={slug:"bring-your-app-day-5",title:"3-5. Bringing Your Application to Kubernetes - CI/CD Secure Supply Chain",authors:["josh"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["cloudnative","azure","kubernetes","azure-key-vault","github-actions","secure-supply-chain","notary","notation"],image:"https://azure.github.io/Cloud-Native/img/og/30-15.png",description:"In this article, you'll learn how to use Notary, an open-source project hosted by the Cloud Native Computing Foundation (CNCF) to digitally sign container images stored on Azure Container Registry.",tags:["cloud-native-new-year","azure-kubernetes-service","aks","kubernetes","secure-supply-chain","notary","notation","azure-key-vault"]},o=void 0,s={permalink:"/Cloud-Native/cnny-2023/bring-your-app-day-5",source:"@site/blog-cnny/2023-02-10/index.md",title:"3-5. Bringing Your Application to Kubernetes - CI/CD Secure Supply Chain",description:"In this article, you'll learn how to use Notary, an open-source project hosted by the Cloud Native Computing Foundation (CNCF) to digitally sign container images stored on Azure Container Registry.",date:"2023-02-10T00:00:00.000Z",formattedDate:"February 10, 2023",tags:[{label:"cloud-native-new-year",permalink:"/Cloud-Native/cnny-2023/tags/cloud-native-new-year"},{label:"azure-kubernetes-service",permalink:"/Cloud-Native/cnny-2023/tags/azure-kubernetes-service"},{label:"aks",permalink:"/Cloud-Native/cnny-2023/tags/aks"},{label:"kubernetes",permalink:"/Cloud-Native/cnny-2023/tags/kubernetes"},{label:"secure-supply-chain",permalink:"/Cloud-Native/cnny-2023/tags/secure-supply-chain"},{label:"notary",permalink:"/Cloud-Native/cnny-2023/tags/notary"},{label:"notation",permalink:"/Cloud-Native/cnny-2023/tags/notation"},{label:"azure-key-vault",permalink:"/Cloud-Native/cnny-2023/tags/azure-key-vault"}],readingTime:5.735,hasTruncateMarker:!1,authors:[{name:"Josh Duffney",title:"Cloud-Native Advocate @Microsoft",url:"https://github.com/duffney",imageURL:"https://github.com/duffney.png",key:"josh"}],frontMatter:{slug:"bring-your-app-day-5",title:"3-5. Bringing Your Application to Kubernetes - CI/CD Secure Supply Chain",authors:["josh"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["cloudnative","azure","kubernetes","azure-key-vault","github-actions","secure-supply-chain","notary","notation"],image:"https://azure.github.io/Cloud-Native/img/og/30-15.png",description:"In this article, you'll learn how to use Notary, an open-source project hosted by the Cloud Native Computing Foundation (CNCF) to digitally sign container images stored on Azure Container Registry.",tags:["cloud-native-new-year","azure-kubernetes-service","aks","kubernetes","secure-supply-chain","notary","notation","azure-key-vault"]},unlisted:!1,prevItem:{title:"3-4. Bringing Your Application to Kubernetes - Debugging and Instrumentation",permalink:"/Cloud-Native/cnny-2023/bring-your-app-day-4"},nextItem:{title:"4-1. Serverless Container Options",permalink:"/Cloud-Native/cnny-2023/serverless-containers"}},l={authorsImageUrls:[void 0]},c=[{value:"What We&#39;ll Cover",id:"what-well-cover",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create a digital signing certificate",id:"create-a-digital-signing-certificate",level:2},{value:"Generate a Azure Container Registry token",id:"generate-a-azure-container-registry-token",level:2},{value:"Setup Notation",id:"setup-notation",level:2},{value:"Install the Notation Azure Key Vault plugin",id:"install-the-notation-azure-key-vault-plugin",level:2},{value:"Add the signing certificate to Notation",id:"add-the-signing-certificate-to-notation",level:2},{value:"Sign Container Images",id:"sign-container-images",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components},{Head:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t,{children:[(0,i.jsx)("meta",{name:"twitter:url",content:"https://azure.github.io/Cloud-Native/cnny-2023/bring-your-app-day-5"}),(0,i.jsx)("meta",{name:"twitter:title",content:"3-5. Bringing Your Application to Kubernetes - CI/CD Secure Supply Chain"}),(0,i.jsx)("meta",{name:"twitter:description",content:"In this article, you'll learn how to use Notary, an open-source project hosted by the Cloud Native Computing Foundation (CNCF) to digitally sign container images stored on Azure Container Registry."}),(0,i.jsx)("meta",{name:"twitter:image",content:"https://azure.github.io/Cloud-Native/img/og/30-15.png"}),(0,i.jsx)("meta",{name:"twitter:card",content:"summary_large_image"}),(0,i.jsx)("meta",{name:"twitter:creator",content:"@joshduffney"}),(0,i.jsx)("meta",{name:"twitter:site",content:"@AzureAdvocates"}),(0,i.jsx)("link",{rel:"canonical",href:"https://azure.github.io/Cloud-Native/cnny-2023/bring-your-app-day-5"})]}),"\n",(0,i.jsxs)(n.p,{children:["Welcome to ",(0,i.jsx)(n.code,{children:"Day 5 of Week 3"})," of #CloudNativeNewYear!"]}),"\n",(0,i.jsx)(n.p,{children:"The theme for this week is Bringing Your Application to Kubernetes. Yesterday we talked about debugging and instrumenting our application. Today we'll explore the topic of container image signing and secure supply chain."}),"\n",(0,i.jsx)(n.admonition,{title:"Ask the Experts Thursday, February 9th at 9 AM PST",type:"tip",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://aka.ms/cnny/watch-ate",children:"Watch our Q&A with Experts from the Azure Kubernetes Service product team!"})})}),"\n",(0,i.jsxs)(n.admonition,{title:"Friday, February 10th at 11 AM PST",type:"tip",children:[(0,i.jsx)(n.p,{children:"Watch the recorded demo and conversation about this week's topics."}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://aka.ms/cnny/week3-demo",children:"We were live on YouTube walking through today's (and the rest of this week's) demos"}),".  Join us Friday, February 10th and bring your questions!"]})]}),"\n",(0,i.jsx)(n.h2,{id:"what-well-cover",children:"What We'll Cover"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Introduction"}),"\n",(0,i.jsx)(n.li,{children:"Prerequisites"}),"\n",(0,i.jsx)(n.li,{children:"Create a digital signing certificate"}),"\n",(0,i.jsx)(n.li,{children:"Generate an Azure Container Registry Token"}),"\n",(0,i.jsx)(n.li,{children:"Set up Notation"}),"\n",(0,i.jsx)(n.li,{children:"Install the Notation Azure Key Vault Plugin"}),"\n",(0,i.jsx)(n.li,{children:"Add the signing Certificate to Notation"}),"\n",(0,i.jsx)(n.li,{children:"Sign Container Images"}),"\n",(0,i.jsx)(n.li,{children:"Conclusion"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"The secure supply chain is a crucial aspect of software development, delivery, and deployment, and digital signing plays a critical role in this process."}),"\n",(0,i.jsx)(n.p,{children:"By using digital signatures to verify the authenticity and integrity of container images, organizations can improve the security of your software supply chain and reduce the risk of security breaches and data compromise."}),"\n",(0,i.jsx)(n.p,{children:"In this article, you'll learn how to use Notary, an open-source project hosted by the Cloud Native Computing Foundation (CNCF) to digitally sign container images stored on Azure Container Registry."}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"To follow along, you'll need an instance of:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/azure/container-registry/",children:"Azure Container Registry"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/azure/key-vault/",children:"Azure Key Vault"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"create-a-digital-signing-certificate",children:"Create a digital signing certificate"}),"\n",(0,i.jsx)(n.p,{children:"A digital signing certificate is a certificate that is used to digitally sign and verify the authenticity and integrity of digital artifacts. Such documents, software, and of course container images."}),"\n",(0,i.jsx)(n.p,{children:"Before you can implement digital signatures, you must first create a digital signing certificate."}),"\n",(0,i.jsx)(n.p,{children:"Run the following command to generate the certificate:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create the policy file"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'cat <<EOF > ./my_policy.json\n{\n    "issuerParameters": {\n        "certificateTransparency": null,\n        "name": "Self"\n    },\n    "x509CertificateProperties": {\n        "ekus": [\n            "1.3.6.1.5.5.7.3.3"\n        ],\n        "key_usage": [\n            "digitalSignature"\n        ],\n        "subject": "CN=${keySubjectName}",\n        "validityInMonths": 12\n    }\n}\nEOF\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"ekus"})," and ",(0,i.jsx)(n.em,{children:"key usage"})," of this certificate policy dictate that the certificate can only be used for digital signatures."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create the certificate in Azure Key Vault"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"az keyvault certificate create --name $keyName --vault-name $keyVaultName --policy @my_policy.json\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Replace ",(0,i.jsx)(n.code,{children:"$keyName"})," and ",(0,i.jsx)(n.code,{children:"$keyVaultName"})," with your desired certificate name and Azure Key Vault instance name."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"generate-a-azure-container-registry-token",children:"Generate a Azure Container Registry token"}),"\n",(0,i.jsx)(n.p,{children:"Azure Container Registry tokens are used to grant access to the contents of the registry. Tokens can be used for a variety of things such as pulling images, pushing images, or managing the registry."}),"\n",(0,i.jsx)(n.p,{children:"As part of the container image signing workflow, you'll need a token to authenticate the Notation CLI with your Azure Container Registry."}),"\n",(0,i.jsx)(n.p,{children:"Run the following command to generate an ACR token:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"az acr token create \\\n  --name $tokenName \\\n  --registry $registry \\\n  --scope-map _repositories_admin \\\n  --query 'credentials.passwords[0].value' \\\n  --only-show-errors \\\n  --output tsv\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Replace ",(0,i.jsx)(n.code,{children:"$tokenName"})," with your name for the ACR token and ",(0,i.jsx)(n.code,{children:"$registry"})," with the name of your ACR instance."]}),"\n",(0,i.jsx)(n.h2,{id:"setup-notation",children:"Setup Notation"}),"\n",(0,i.jsxs)(n.p,{children:["Notation is the command-line interface for the CNCF Notary project. You'll use it to digitally sign the ",(0,i.jsx)(n.em,{children:"api"})," and ",(0,i.jsx)(n.em,{children:"web"})," container images for the eShopOnWeb application."]}),"\n",(0,i.jsx)(n.p,{children:"Run the following commands to download and install the NotationCli:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Open a terminal or command prompt window"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Download the Notary notation release"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -Lo notation.tar.gz https://github.com/notaryproject/notation/releases/download/v1.0.0-rc.1/notation_1.0.0-rc.1_linux_amd64.tar.gz > /dev/null 2>&1\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If you're not using Linux, you can find the releases ",(0,i.jsx)(n.a,{href:"https://github.com/notaryproject/notation/releases",children:"here"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Extract the contents of the ",(0,i.jsx)(n.code,{children:"notation.tar.gz"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"tar xvzf notation.tar.gz > /dev/null 2>&1\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Copy the notation binary to the $HOME/bin directory"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cp ./notation $HOME/bin\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add the $HOME/bin directory to the PATH environment variable"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'export PATH="$HOME/bin:$PATH"\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Remove the downloaded files"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"rm notation.tar.gz LICENSE\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Check the notation version"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"notation --version\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"install-the-notation-azure-key-vault-plugin",children:"Install the Notation Azure Key Vault plugin"}),"\n",(0,i.jsx)(n.p,{children:"By design the NotationCli supports plugins that extend its digital signing capabilities to remote registries. And in order to sign your container images stored in Azure Container Registry, you'll need to install the Azure Key Vault plugin for Notation."}),"\n",(0,i.jsxs)(n.p,{children:["Run the following commands to install the ",(0,i.jsx)(n.code,{children:"azure-kv"})," plugin:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Download the plugin"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -Lo notation-azure-kv.tar.gz \\\n    https://github.com/Azure/notation-azure-kv/releases/download/v0.5.0-rc.1/notation-azure-kv_0.5.0-rc.1_linux_amd64.tar.gz > /dev/null 2>&1\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Non-Linux releases can be found ",(0,i.jsx)(n.a,{href:"https://github.com/Azure/notation-azure-kv/releases/",children:"here"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Extract to the plugin directory & delete download files"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"tar xvzf notation-azure-kv.tar.gz -C ~/.config/notation/plugins/azure-kv notation-azure-kv > /dev/null 2>&\n\nrm -rf notation-azure-kv.tar.gz\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Verify the plugin was installed"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"notation plugin ls\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"add-the-signing-certificate-to-notation",children:"Add the signing certificate to Notation"}),"\n",(0,i.jsx)(n.p,{children:"Now that you have Notation and the Azure Key Vault plugin installed, add the certificate's keyId created above to Notation."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Get the Certificate Key ID from Azure Key Vault"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'az keyvault certificate show \\\n  --vault-name $keyVaultName \\\n  --name $keyName \\\n  --query "kid" --only-show-errors --output tsv\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Replace ",(0,i.jsx)(n.code,{children:"$keyVaultName"})," and ",(0,i.jsx)(n.code,{children:"$keyName"})," with the appropriate information."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add the Key ID to KMS using Notation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"notation key add --plugin azure-kv --id $keyID $keyName\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Check the key list"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"notation key ls\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"sign-container-images",children:"Sign Container Images"}),"\n",(0,i.jsx)(n.p,{children:"At this point, all that's left is to sign the container images."}),"\n",(0,i.jsxs)(n.p,{children:["Run the ",(0,i.jsx)(n.code,{children:"notation sign"})," command to sign the api and web container images:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"notation sign $registry.azurecr.io/web:$tag \\\n  --username $tokenName \\\n  --password $tokenPassword\n\nnotation sign $registry.azurecr.io/api:$tag \\\n  --username $tokenName \\\n  --password $tokenPassword\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Replace ",(0,i.jsx)(n.code,{children:"$registry"}),", ",(0,i.jsx)(n.code,{children:"$tag"}),", ",(0,i.jsx)(n.code,{children:"$tokenName"}),", and ",(0,i.jsx)(n.code,{children:"$tokenPassword"})," with the appropriate values. To improve security, use a SHA hash for the tag."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"NOTE"}),": If you didn't take note of the token password, you can rerun the ",(0,i.jsx)(n.code,{children:"az acr token create"})," command to generate a new password."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(n.p,{children:"Digital signing plays a critical role in ensuring the security of software supply chains."}),"\n",(0,i.jsx)(n.p,{children:"By signing software components, organizations can verify the authenticity and integrity of software, helping to prevent unauthorized modifications, tampering, and malware."}),"\n",(0,i.jsxs)(n.p,{children:["And if you want to take digital signing to a whole new level by using them to prevent the deployment of unsigned container images, check out the ",(0,i.jsx)(n.a,{href:"https://github.com/deislabs/ratify",children:"Ratify"})," project on GitHub!"]}),"\n",(0,i.jsxs)(n.admonition,{title:"Take the Cloud Skills Challenge!",type:"tip",children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/training/challenges?id=a0e385b9-f970-4182-b2e2-3b4619b6c356",children:"Enroll"})," in the Cloud Skills Challenge!"]}),(0,i.jsx)(n.p,{children:"Don't miss out on this opportunity to level up your skills and stay ahead of the curve in the world of cloud native."})]})]})}function u(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>o});var i=t(67294);const a={},r=i.createContext(a);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);