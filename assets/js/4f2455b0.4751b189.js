"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[15851],{14098:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var i=t(85893),r=t(11151);const a={slug:"bring-your-app-day-1",title:"3-1. Bringing Your Application to Kubernetes - CI/CD",authors:["steven"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["pods","deployments","kubernetes","aks","container-apps","cloud-native","github-actions","ci-cd"],image:"https://azure.github.io/Cloud-Native/img/og/30-11.png",description:"Taking a existing application, containerizing it, and publishing to Kubernetes in GitHub Actions.",tags:["cloud-native","30daysofcloudnative","zero-to-hero","ask-the-expert","azure-kubernetes-service"]},s=void 0,o={permalink:"/Cloud-Native/cnny-2023/bring-your-app-day-1",source:"@site/blog-cnny/2023-02-06/index.md",title:"3-1. Bringing Your Application to Kubernetes - CI/CD",description:"Taking a existing application, containerizing it, and publishing to Kubernetes in GitHub Actions.",date:"2023-02-06T00:00:00.000Z",formattedDate:"February 6, 2023",tags:[{label:"cloud-native",permalink:"/Cloud-Native/cnny-2023/tags/cloud-native"},{label:"30daysofcloudnative",permalink:"/Cloud-Native/cnny-2023/tags/30-daysofcloudnative"},{label:"zero-to-hero",permalink:"/Cloud-Native/cnny-2023/tags/zero-to-hero"},{label:"ask-the-expert",permalink:"/Cloud-Native/cnny-2023/tags/ask-the-expert"},{label:"azure-kubernetes-service",permalink:"/Cloud-Native/cnny-2023/tags/azure-kubernetes-service"}],readingTime:13.095,hasTruncateMarker:!1,authors:[{name:"Steven Murawski",title:"Principal Cloud Advocate",url:"https://github.com/smurawski",imageURL:"https://github.com/smurawski.png",key:"steven"}],frontMatter:{slug:"bring-your-app-day-1",title:"3-1. Bringing Your Application to Kubernetes - CI/CD",authors:["steven"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["pods","deployments","kubernetes","aks","container-apps","cloud-native","github-actions","ci-cd"],image:"https://azure.github.io/Cloud-Native/img/og/30-11.png",description:"Taking a existing application, containerizing it, and publishing to Kubernetes in GitHub Actions.",tags:["cloud-native","30daysofcloudnative","zero-to-hero","ask-the-expert","azure-kubernetes-service"]},unlisted:!1,prevItem:{title:"2-5. Kubernetes Fundamentals - Scaling Pods and Nodes",permalink:"/Cloud-Native/cnny-2023/fundamentals-day-5"},nextItem:{title:"3-2. Bringing Your Application to Kubernetes - Adapting Storage, Secrets, and Configuration",permalink:"/Cloud-Native/cnny-2023/bring-your-app-day-2"}},l={authorsImageUrls:[void 0]},d=[{value:"What We&#39;ll Cover",id:"what-well-cover",level:2},{value:"Our Application",id:"our-application",level:2},{value:"Adding Some Infrastructure as Code",id:"adding-some-infrastructure-as-code",level:2},{value:"Federated Identity",id:"federated-identity",level:3},{value:"Prerequisites",id:"prerequisites",level:4},{value:"Set Up Some Defaults",id:"set-up-some-defaults",level:4},{value:"Create an Azure AD Application",id:"create-an-azure-ad-application",level:4},{value:"Set Up Federation for that Azure AD Application",id:"set-up-federation-for-that-azure-ad-application",level:4},{value:"Create a Service Principal for the Azure AD Application",id:"create-a-service-principal-for-the-azure-ad-application",level:4},{value:"Give that Service Principal Rights to Azure Resources",id:"give-that-service-principal-rights-to-azure-resources",level:3},{value:"Add Secrets to GitHub Repository",id:"add-secrets-to-github-repository",level:4},{value:"Creating a Bicep Deployment",id:"creating-a-bicep-deployment",level:3},{value:"Resuable Workflows",id:"resuable-workflows",level:4},{value:"Adding the Bicep Deployment",id:"adding-the-bicep-deployment",level:3},{value:"Permissions",id:"permissions",level:4},{value:"Deploy AKS Job",id:"deploy-aks-job",level:4},{value:"Building and Publishing a Container Image",id:"building-and-publishing-a-container-image",level:2},{value:"Add a Reusable Workflow",id:"add-a-reusable-workflow",level:3},{value:"Build the Container Images",id:"build-the-container-images",level:4},{value:"Scan the Container Images",id:"scan-the-container-images",level:4},{value:"Publish the Container Images",id:"publish-the-container-images",level:4},{value:"Update the Build With the Image Build and Publish",id:"update-the-build-with-the-image-build-and-publish",level:3},{value:"Deploying to Kubernetes",id:"deploying-to-kubernetes",level:2},{value:"Starting the Reusable Workflow to Deploy to AKS",id:"starting-the-reusable-workflow-to-deploy-to-aks",level:3},{value:"Edit the Deployment For Our Current Image Tag",id:"edit-the-deployment-for-our-current-image-tag",level:3},{value:"Kustomize Definition",id:"kustomize-definition",level:4},{value:"Replacing Values in our Build",id:"replacing-values-in-our-build",level:4},{value:"Deploying the Manifests",id:"deploying-the-manifests",level:3},{value:"Summary",id:"summary",level:2},{value:"Resources",id:"resources",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components},{Head:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t,{children:[(0,i.jsx)("meta",{name:"twitter:url",content:"https://azure.github.io/Cloud-Native/cnny-2023/bring-your-app-day-1"}),(0,i.jsx)("meta",{name:"twitter:title",content:"3-1. Bringing Your Application to Kubernetes - CI/CD"}),(0,i.jsx)("meta",{name:"twitter:description",content:"Taking a existing application, containerizing it, and publishing to Kubernetes in GitHub Actions."}),(0,i.jsx)("meta",{name:"twitter:image",content:"https://azure.github.io/Cloud-Native/img/og/30-11.png"}),(0,i.jsx)("meta",{name:"twitter:card",content:"summary_large_image"}),(0,i.jsx)("meta",{name:"twitter:creator",content:"@stevenmurawski"}),(0,i.jsx)("meta",{name:"twitter:site",content:"@AzureAdvocates"}),(0,i.jsx)("link",{rel:"canonical",href:"https://azure.github.io/Cloud-Native/cnny-2023/bring-your-app-day-1"})]}),"\n",(0,i.jsxs)(n.p,{children:["Welcome to ",(0,i.jsx)(n.code,{children:"Day 1 of Week 3"})," of #CloudNativeNewYear!"]}),"\n",(0,i.jsx)(n.p,{children:"The theme for this week is Bringing Your Application to Kubernetes. Last we talked about Kubernetes Fundamentals. Today we'll explore getting an existing application running in Kubernetes with a full pipeline in GitHub Actions."}),"\n",(0,i.jsx)(n.admonition,{title:"Ask the Experts Thursday, February 9th at 9 AM PST",type:"tip",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://aka.ms/cnny/watch-ate",children:"Watch our Q&A with Experts from the Azure Kubernetes Service product team!"})})}),"\n",(0,i.jsxs)(n.admonition,{title:"Friday, February 10th at 11 AM PST",type:"tip",children:[(0,i.jsx)(n.p,{children:"Watch the recorded demo and conversation about this week's topics."}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://aka.ms/cnny/week3-demo",children:"We were live on YouTube walking through today's (and the rest of this week's) demos"}),".  Join us Friday, February 10th and bring your questions!"]})]}),"\n",(0,i.jsx)(n.h2,{id:"what-well-cover",children:"What We'll Cover"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Our Application"}),"\n",(0,i.jsx)(n.li,{children:"Adding Some Infrastructure as Code"}),"\n",(0,i.jsx)(n.li,{children:"Building and Publishing a Container Image"}),"\n",(0,i.jsx)(n.li,{children:"Deploying to Kubernetes"}),"\n",(0,i.jsx)(n.li,{children:"Summary"}),"\n",(0,i.jsx)(n.li,{children:"Resources"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"our-application",children:"Our Application"}),"\n",(0,i.jsxs)(n.p,{children:["This week we'll be taking an exisiting application - something similar to a typical line of business application - and setting it up to run in Kubernetes.  Over the course of the week, we'll address different concerns.  Today we'll focus on updating our CI/CD process to handle standing up (or validating that we have) an ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=containers-84290-stmuraws",children:"Azure Kubernetes Service (AKS)"})," environment, building and publishing container images for our web site and API server, and getting those services running in Kubernetes."]}),"\n",(0,i.jsxs)(n.p,{children:["The application we'll be starting with is ",(0,i.jsx)(n.a,{href:"https://github.com/Azure-Samples/eShopOnAKS",children:"eShopOnWeb"}),".  This application has a web site and API which are backed by a SQL Server instance.  It's built in .NET 7, so it's cross-platform."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["For the enterprising among you, you may notice that there are a number of different eShopOn* variants on GitHub, including ",(0,i.jsx)(n.a,{href:"https://github.com/dotnet-architecture/eShopOnContainers",children:"eShopOnContainers"}),".  We aren't using that example as it's more of an end state than a starting place. Afterwards, feel free to check out that example as what this solution could look like as a series of microservices."]})}),"\n",(0,i.jsx)(n.h2,{id:"adding-some-infrastructure-as-code",children:"Adding Some Infrastructure as Code"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"/Cloud-Native/cnny-2023/fundamentals-day-1#setting-up-a-kubernetes-environment-in-azure",children:"Just like last week"}),", we need to stand up an AKS environment.  This week, however, rather than running commands in our own shell, we'll set up GitHub Actions to do that for us."]}),"\n",(0,i.jsxs)(n.p,{children:["There is a ",(0,i.jsx)(n.strong,{children:"LOT"})," of plumbing in this section, ",(0,i.jsx)(n.strong,{children:"but"})," once it's set up, it'll make our lives a lot easier.  This section ensures that we have an environment to deploy our application into configured the way we want.  We can easily extend this to accomodate multiple environments or add additional microservices with minimal new effort."]}),"\n",(0,i.jsx)(n.h3,{id:"federated-identity",children:"Federated Identity"}),"\n",(0,i.jsxs)(n.p,{children:["Setting up a federated identity will allow us a more securable and auditable way of accessing Azure from GitHub Actions.  For more about setting up a federated identity, Microsoft Learn has the details on ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/azure/developer/github/connect-from-azure?tabs=azure-portal%2Cwindows&WT.mc_id=containers-84290-stmuraws",children:"connecting GitHub Actions to Azure"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Here, we'll just walk through the setup of the identity and configure GitHub to use that idenity to deploy our AKS environment and interact with our Azure Container Registry."}),"\n",(0,i.jsxs)(n.p,{children:["The examples will use PowerShell, but a Bash version of the setup commands is available in the ",(0,i.jsx)(n.a,{href:"https://github.com/Azure-Samples/eShopOnAKS/tree/week3/day1",children:"week3/day1 branch"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"To follow along, you'll need:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"a GitHub account"}),"\n",(0,i.jsx)(n.li,{children:"an Azure Subscription"}),"\n",(0,i.jsx)(n.li,{children:"the Azure CLI"}),"\n",(0,i.jsx)(n.li,{children:"and the Git CLI."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["You'll need to fork the ",(0,i.jsx)(n.a,{href:"https://github.com/Azure-Samples/eShopOnAKS",children:"source repository"})," under your GitHub user or organization where you can manage secrets and GitHub Actions."]}),"\n",(0,i.jsxs)(n.p,{children:["It would be helpful to have the ",(0,i.jsx)(n.a,{href:"https://cli.github.com/",children:"GitHub CLI"}),", but it's not required."]}),"\n",(0,i.jsx)(n.h4,{id:"set-up-some-defaults",children:"Set Up Some Defaults"}),"\n",(0,i.jsx)(n.p,{children:"You will need to update one or more of the variables (your user or organization, what branch you want to work off of, and possibly the Azure AD application name if there is a conflict)."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"# Replace the gitHubOrganizationName value\n# with the user or organization you forked\n# the repository under.\n\n$githubOrganizationName = 'Azure-Samples'\n$githubRepositoryName  = 'eShopOnAKS'\n$branchName = 'week3/day1'\n$applicationName = 'cnny-week3-day1'\n"})}),"\n",(0,i.jsx)(n.h4,{id:"create-an-azure-ad-application",children:"Create an Azure AD Application"}),"\n",(0,i.jsx)(n.p,{children:"Next, we need to create an Azure AD application."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"# Create an Azure AD application\n$aksDeploymentApplication = New-AzADApplication -DisplayName $applicationName\n"})}),"\n",(0,i.jsx)(n.h4,{id:"set-up-federation-for-that-azure-ad-application",children:"Set Up Federation for that Azure AD Application"}),"\n",(0,i.jsx)(n.p,{children:"And configure that application to allow federated credential requests from our GitHub repository for a particular branch."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"# Create a federated identity credential for the application\nNew-AzADAppFederatedCredential `\n   -Name $applicationName `\n   -ApplicationObjectId $aksDeploymentApplication.Id `\n   -Issuer 'https://token.actions.githubusercontent.com' `\n   -Audience 'api://AzureADTokenExchange' `\n   -Subject \"repo:$($githubOrganizationName)/$($githubRepositoryName):ref:refs/heads/$branchName\"\n"})}),"\n",(0,i.jsx)(n.h4,{id:"create-a-service-principal-for-the-azure-ad-application",children:"Create a Service Principal for the Azure AD Application"}),"\n",(0,i.jsx)(n.p,{children:"Once the application has been created, we need a service principal tied to that application.  The service principal can be granted rights in Azure."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"# Create a service principal for the application\nNew-AzADServicePrincipal -AppId $($aksDeploymentApplication.AppId)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"give-that-service-principal-rights-to-azure-resources",children:"Give that Service Principal Rights to Azure Resources"}),"\n",(0,i.jsx)(n.p,{children:"Because our Bicep deployment exists at the subscription level and we are creating role assignments, we need to give it Owner rights. If we changed the scope of the deployment to just a resource group, we could apply more scoped permissions."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"$azureContext = Get-AzContext\nNew-AzRoleAssignment `\n   -ApplicationId $($aksDeploymentApplication.AppId) `\n   -RoleDefinitionName Owner `\n   -Scope $azureContext.Subscription.Id\n"})}),"\n",(0,i.jsx)(n.h4,{id:"add-secrets-to-github-repository",children:"Add Secrets to GitHub Repository"}),"\n",(0,i.jsx)(n.p,{children:"If you have the GitHub CLI, you can use that right from your shell to set the secrets needed."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"gh secret set AZURE_CLIENT_ID --body $aksDeploymentApplication.AppId\ngh secret set AZURE_TENANT_ID --body $azureContext.Tenant.Id\ngh secret set AZURE_SUBSCRIPTION_ID --body $azureContext.Subscription.Id\n"})}),"\n",(0,i.jsx)(n.p,{children:"Otherwise, you can create them through the web interface like I did in the Learn Live event below."}),"\n",(0,i.jsxs)(n.admonition,{type:"info",children:[(0,i.jsx)(n.p,{children:"It may look like the whole video will play, but it'll stop after configuring the secrets in GitHub (after about 9 minutes)"}),(0,i.jsx)(n.p,{children:"The video shows creating the Azure AD application, service principals, and configuring the federated identity in Azure AD and GitHub."})]}),"\n",(0,i.jsx)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/sZ0Z-4r08so?start=1613&end=2124",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowfullscreen:!0}),"\n",(0,i.jsx)(n.h3,{id:"creating-a-bicep-deployment",children:"Creating a Bicep Deployment"}),"\n",(0,i.jsx)(n.h4,{id:"resuable-workflows",children:"Resuable Workflows"}),"\n",(0,i.jsxs)(n.p,{children:["We'll create our Bicep deployment in a ",(0,i.jsx)(n.a,{href:"https://docs.github.com/actions/using-workflows/reusing-workflows",children:"reusable workflows"}),".  What are they?  The previous link has the documentation or the video below has ",(0,i.jsx)(n.a,{href:"https://twitter.com/brandonmartinez",children:"my colleague Brandon Martinez"})," and I talking about them."]}),"\n",(0,i.jsx)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/sZ0Z-4r08so?start=1065&end=1524",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowfullscreen:!0}),"\n",(0,i.jsxs)(n.p,{children:["This workflow is basically ",(0,i.jsx)(n.a,{href:"/Cloud-Native/cnny-2023/fundamentals-day-1#setting-up-a-kubernetes-environment-in-azure",children:"the same deployment"})," we did in last week's series, just in GitHub Actions."]}),"\n",(0,i.jsxs)(n.p,{children:["Start by creating a file called ",(0,i.jsx)(n.code,{children:"deploy_aks.yml"})," in the ",(0,i.jsx)(n.code,{children:".github/workflows"})," directory with the below contents."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"name: deploy\n\non:\n  workflow_call:\n    inputs:\n      resourceGroupName:\n        required: true\n        type: string\n    secrets:\n      AZURE_CLIENT_ID:\n        required: true\n      AZURE_TENANT_ID:\n        required: true\n      AZURE_SUBSCRIPTION_ID:\n        required: true\n    outputs:\n      containerRegistryName:\n        description: Container Registry Name\n        value: ${{ jobs.deploy.outputs.containerRegistryName }}\n      containerRegistryUrl:\n        description: Container Registry Login Url\n        value: ${{ jobs.deploy.outputs.containerRegistryUrl }}\n      resourceGroupName:\n        description: Resource Group Name\n        value: ${{ jobs.deploy.outputs.resourceGroupName }}\n      aksName:\n        description: Azure Kubernetes Service Cluster Name\n        value: ${{ jobs.deploy.outputs.aksName }}\n\npermissions:\n  id-token: write\n  contents: read\n\njobs:\n  validate:\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v2\n    - uses: azure/login@v1\n      name: Sign in to Azure\n      with:\n        client-id: ${{ secrets.AZURE_CLIENT_ID }}\n        tenant-id: ${{ secrets.AZURE_TENANT_ID }}\n        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}\n    - uses: azure/arm-deploy@v1\n      name: Run preflight validation\n      with:\n        deploymentName: ${{ github.run_number }}\n        scope: subscription\n        region: eastus\n        template: ./deploy/main.bicep\n        parameters: >\n          resourceGroup=${{ inputs.resourceGroupName }}\n        deploymentMode: Validate\n\n  deploy:\n    needs: validate\n    runs-on: ubuntu-latest\n    outputs:\n      containerRegistryName: ${{ steps.deploy.outputs.acr_name }}\n      containerRegistryUrl: ${{ steps.deploy.outputs.acr_login_server_url }}\n      resourceGroupName: ${{ steps.deploy.outputs.resource_group_name }}\n      aksName: ${{ steps.deploy.outputs.aks_name }}\n    steps:\n    - uses: actions/checkout@v2\n    - uses: azure/login@v1\n      name: Sign in to Azure\n      with:\n        client-id: ${{ secrets.AZURE_CLIENT_ID }}\n        tenant-id: ${{ secrets.AZURE_TENANT_ID }}\n        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}\n    - uses: azure/arm-deploy@v1\n      id: deploy\n      name: Deploy Bicep file\n      with:\n        failOnStdErr: false\n        deploymentName: ${{ github.run_number }}\n        scope: subscription\n        region: eastus\n        template: ./deploy/main.bicep\n        parameters: >\n          resourceGroup=${{ inputs.resourceGroupName }}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"adding-the-bicep-deployment",children:"Adding the Bicep Deployment"}),"\n",(0,i.jsxs)(n.p,{children:["Once we have the Bicep deployment workflow, we can add it to the primary build definition in ",(0,i.jsx)(n.code,{children:".github/workflows/dotnetcore.yml"})]}),"\n",(0,i.jsx)(n.h4,{id:"permissions",children:"Permissions"}),"\n",(0,i.jsx)(n.p,{children:"First, we need to add a permissions block to let the workflow request our Azure AD token.  This can go towards the top of the YAML file (I started it on line 5)."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"permissions:\n  id-token: write\n  contents: read\n"})}),"\n",(0,i.jsx)(n.h4,{id:"deploy-aks-job",children:"Deploy AKS Job"}),"\n",(0,i.jsxs)(n.p,{children:["Next, we'll add a reference to our reusable workflow.  This will go after the ",(0,i.jsx)(n.code,{children:"build"})," job."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"  deploy_aks:\n    needs: [build]\n    uses: ./.github/workflows/deploy_aks.yml\n    with:\n      resourceGroupName: 'cnny-week3'\n    secrets:\n      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}\n      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}\n      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"building-and-publishing-a-container-image",children:"Building and Publishing a Container Image"}),"\n",(0,i.jsx)(n.p,{children:"Now that we have our target environment in place and an Azure Container Registry, we can build and publish our container images."}),"\n",(0,i.jsx)(n.h3,{id:"add-a-reusable-workflow",children:"Add a Reusable Workflow"}),"\n",(0,i.jsxs)(n.p,{children:["First, we'll create a new file for our reusable workflow at ",(0,i.jsx)(n.code,{children:".github/workflows/publish_container_image.yml"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"We'll start the file with a name, the parameters it needs to run, and the permissions requirements for the federated identity request."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"name: Publish Container Images\n\non: \n  workflow_call:\n    inputs:\n      containerRegistryName:\n        required: true\n        type: string\n      containerRegistryUrl:\n        required: true\n        type: string\n      githubSha:\n        required: true\n        type: string\n    secrets:\n      AZURE_CLIENT_ID:\n        required: true\n      AZURE_TENANT_ID:\n        required: true\n      AZURE_SUBSCRIPTION_ID:\n        required: true\n\npermissions:\n  id-token: write\n  contents: read\n"})}),"\n",(0,i.jsx)(n.h4,{id:"build-the-container-images",children:"Build the Container Images"}),"\n",(0,i.jsx)(n.p,{children:"Our next step is to build the two container images we'll need for the application, the website and the API.  We'll build the container images on our build worker and tag it with the git SHA, so there'll be a direct tie between the point in time in our codebase and the container images that represent it."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"jobs:\n  publish_container_image:\n    runs-on: ubuntu-latest\n\n    steps:\n    - uses: actions/checkout@v2\n    - name: docker build\n      run: |\n        docker build . -f src/Web/Dockerfile -t ${{ inputs.containerRegistryUrl }}/web:${{ inputs.githubSha }}\n        docker build . -f src/PublicApi/Dockerfile -t ${{ inputs.containerRegistryUrl }}/api:${{ inputs.githubSha}}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"scan-the-container-images",children:"Scan the Container Images"}),"\n",(0,i.jsx)(n.p,{children:"Before we publish those container images, we'll scan them for vulnerabilities and best practice violations.  We can add these two steps (one scan for each image)."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"    - name: scan web container image\n      uses: Azure/container-scan@v0\n      with:\n        image-name: ${{ inputs.containerRegistryUrl }}/web:${{ inputs.githubSha}}\n    - name: scan api container image\n      uses: Azure/container-scan@v0\n      with:\n        image-name: ${{ inputs.containerRegistryUrl }}/web:${{ inputs.githubSha}}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The container images provided have a few items that'll be found. We can create an allowed list at ",(0,i.jsx)(n.code,{children:".github/containerscan/allowedlist.yaml"})," to define vulnerabilities or best practice violations that we'll explictly allow to ",(0,i.jsx)(n.strong,{children:"not"})," fail our build."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"general:\n  vulnerabilities:\n    - CVE-2022-29458\n    - CVE-2022-3715\n    - CVE-2022-1304\n    - CVE-2021-33560\n    - CVE-2020-16156\n    - CVE-2019-8457\n    - CVE-2018-8292\n  bestPracticeViolations:\n    - CIS-DI-0001\n    - CIS-DI-0005  \n    - CIS-DI-0006 \n    - CIS-DI-0008  \n"})}),"\n",(0,i.jsx)(n.h4,{id:"publish-the-container-images",children:"Publish the Container Images"}),"\n",(0,i.jsx)(n.p,{children:"Finally, we'll log in to Azure, then log in to our Azure Container Registry, and push our images."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"    - uses: azure/login@v1\n      name: Sign in to Azure\n      with:\n        client-id: ${{ secrets.AZURE_CLIENT_ID }}\n        tenant-id: ${{ secrets.AZURE_TENANT_ID }}\n        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}\n    - name: acr login \n      run: az acr login --name ${{ inputs.containerRegistryName  }}\n    - name: docker push\n      run: |\n        docker push ${{ inputs.containerRegistryUrl }}/web:${{ inputs.githubSha}}\n        docker push ${{ inputs.containerRegistryUrl }}/api:${{ inputs.githubSha}}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"update-the-build-with-the-image-build-and-publish",children:"Update the Build With the Image Build and Publish"}),"\n",(0,i.jsxs)(n.p,{children:["Now that we have our reusable workflow to create and publish our container images, we can include that in our primary build defnition at ",(0,i.jsx)(n.code,{children:".github/workflows/dotnetcore.yml"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"  publish_container_image:\n    needs: [deploy_aks]\n    uses: ./.github/workflows/publish_container_image.yml\n    with:\n      containerRegistryName: ${{ needs.deploy_aks.outputs.containerRegistryName }}\n      containerRegistryUrl: ${{ needs.deploy_aks.outputs.containerRegistryUrl }}\n      githubSha: ${{ github.sha }}\n    secrets:\n      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}\n      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}\n      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"deploying-to-kubernetes",children:"Deploying to Kubernetes"}),"\n",(0,i.jsx)(n.p,{children:"Finally, we've gotten enough set up that a commit to the target branch will:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"build and test our application code"}),"\n",(0,i.jsx)(n.li,{children:"set up (or validate) our AKS and ACR environment"}),"\n",(0,i.jsx)(n.li,{children:"and create, scan, and publish our container images to ACR"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Our last step will be to deploy our application to Kubernetes.  We'll use the basic building blocks we worked with last week, ",(0,i.jsx)(n.a,{href:"/Cloud-Native/cnny-2023/fundamentals-day-1#creating-the-deployment",children:"deployments"})," and ",(0,i.jsx)(n.a,{href:"/Cloud-Native/cnny-2023/fundamentals-day-2#exposing-pods-via-service",children:"services"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"starting-the-reusable-workflow-to-deploy-to-aks",children:"Starting the Reusable Workflow to Deploy to AKS"}),"\n",(0,i.jsx)(n.p,{children:"We'll start our workflow with our parameters that we need, as well as the permissions to access the token to log in to Azure."}),"\n",(0,i.jsxs)(n.p,{children:["We'll check out our code, then log in to Azure, and use the ",(0,i.jsx)(n.code,{children:"az"})," CLI to get credentials for our AKS cluster."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"name: deploy_to_aks\n\non:\n  workflow_call:\n    inputs:\n      aksName:\n        required: true\n        type: string\n      resourceGroupName:\n        required: true\n        type: string\n      containerRegistryUrl:\n        required: true\n        type: string\n      githubSha:\n        required: true\n        type: string\n    secrets:\n      AZURE_CLIENT_ID:\n        required: true\n      AZURE_TENANT_ID:\n        required: true\n      AZURE_SUBSCRIPTION_ID:\n        required: true\n\npermissions:\n  id-token: write\n  contents: read\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:  \n      - uses: actions/checkout@v2\n      - uses: azure/login@v1\n        name: Sign in to Azure\n        with:\n          client-id: ${{ secrets.AZURE_CLIENT_ID }}\n          tenant-id: ${{ secrets.AZURE_TENANT_ID }}\n          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}\n      - name: Get AKS Credentials\n        run: |\n          az aks get-credentials --resource-group ${{ inputs.resourceGroupName }} --name ${{ inputs.aksName }}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"edit-the-deployment-for-our-current-image-tag",children:"Edit the Deployment For Our Current Image Tag"}),"\n",(0,i.jsxs)(n.p,{children:["Let's add the Kubernetes manifests to our repo.  This post is long enough, so you can find the content for the manifests folder ",(0,i.jsxs)(n.a,{href:"https://github.com/Azure-Samples/eShopOnAKS/tree/week3/day1/manifests",children:["in the manifests folder in the source repo under the ",(0,i.jsx)(n.code,{children:"week3/day1"})," branch"]}),"."]}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsxs)(n.p,{children:["If you only forked the main branch of the source repo, you can easily get the updated manifests by using the following ",(0,i.jsx)(n.code,{children:"git"})," commands:"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-powershell",children:"git remote add upstream https://github.com/Azure-Samples/eShopOnAks\ngit fetch upstream week3/day1\ngit checkout upstream/week3/day1 manifests\n"})}),(0,i.jsxs)(n.p,{children:["This will make the ",(0,i.jsx)(n.code,{children:"week3/day1"})," branch available locally and then we can update the manifests directory to match the state of that branch."]})]}),"\n",(0,i.jsxs)(n.p,{children:["The deployments and the service defintions should be familiar from last week's content (but not the same).  This week, however, there's a new file in the manifests - ",(0,i.jsx)(n.code,{children:"./manifests/kustomization.yaml"})]}),"\n",(0,i.jsxs)(n.p,{children:["This file helps us more dynamically edit our kubernetes manifests and support is baked right in to the ",(0,i.jsx)(n.code,{children:"kubectl"})," command."]}),"\n",(0,i.jsx)(n.h4,{id:"kustomize-definition",children:"Kustomize Definition"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://kustomize.io/",children:"Kustomize"})," allows us to specify specific resource manifests and areas of that manifest to replace.  We've put some placeholders in our file as well, so we can replace those for each run of our CI/CD system."]}),"\n",(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.code,{children:"./manifests/kustomization.yaml"})," you will see:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"resources:\n- deployment-api.yaml\n- deployment-web.yaml\n\n# Change the image name and version\nimages:\n- name: notavalidregistry.azurecr.io/api:v0.1.0\n  newName: <YOUR_ACR_SERVER>/api\n  newTag: <YOUR_IMAGE_TAG>\n- name: notavalidregistry.azurecr.io/web:v0.1.0\n  newName: <YOUR_ACR_SERVER>/web\n  newTag: <YOUR_IMAGE_TAG>\n"})}),"\n",(0,i.jsx)(n.h4,{id:"replacing-values-in-our-build",children:"Replacing Values in our Build"}),"\n",(0,i.jsxs)(n.p,{children:["Now, we encounter a little problem - our deployment files need to know the tag and ACR server.  We can do a bit of ",(0,i.jsx)(n.code,{children:"sed"})," magic to edit the file on the fly."]}),"\n",(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.code,{children:".github/workflows/deploy_to_aks.yml"}),", we'll add:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:'      - name: replace_placeholders_with_current_run\n        run: |\n          sed -i "s/<YOUR_ACR_SERVER>/${{ inputs.containerRegistryUrl }}/g" ./manifests/kustomization.yaml\n          sed -i "s/<YOUR_IMAGE_TAG>/${{ inputs.githubSha }}/g" ./manifests/kustomization.yaml\n'})}),"\n",(0,i.jsx)(n.h3,{id:"deploying-the-manifests",children:"Deploying the Manifests"}),"\n",(0,i.jsxs)(n.p,{children:["We have our manifests in place and our ",(0,i.jsx)(n.code,{children:"kustomization.yaml"})," file (with commands to update it at runtime) ready to go, we can deploy our manifests."]}),"\n",(0,i.jsxs)(n.p,{children:["First, we'll deploy our database (deployment and service).\nNext, we'll use the ",(0,i.jsx)(n.code,{children:"-k"})," parameter on ",(0,i.jsx)(n.code,{children:"kubectl"})," to tell it to look for a ",(0,i.jsx)(n.code,{children:"kustomize"})," configuration, transform the requested manifests and apply those.\nFinally, we apply the service defintions for the web and API deployments."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"        run: |\n          kubectl apply -f ./manifests/deployment-db.yaml \\\n                        -f ./manifests/service-db.yaml\n          kubectl apply -k ./manifests\n          kubectl apply -f ./manifests/service-api.yaml \\\n                        -f ./manifests/service-web.yaml\n"})}),"\n",(0,i.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsx)(n.p,{children:"We've covered a lot of ground in today's post.  We set up federated credentials with GitHub.  Then we added reusable workflows to deploy an AKS environment and build/scan/publish our container images, and then to deploy them into our AKS environment."}),"\n",(0,i.jsx)(n.p,{children:"This sets us up to start making changes to our application and Kubernetes configuration and have those changes automatically validated and deployed by our CI/CD system.  Tomorrow, we'll look at updating our application environment with runtime configuration, persistent storage, and more."}),"\n",(0,i.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,i.jsxs)(n.admonition,{title:"Take the Cloud Skills Challenge!",type:"tip",children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/training/challenges?id=a0e385b9-f970-4182-b2e2-3b4619b6c356",children:"Enroll"})," in the Cloud Skills Challenge!"]}),(0,i.jsx)(n.p,{children:"Don't miss out on this opportunity to level up your skills and stay ahead of the curve in the world of cloud native."})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=containers-84290-stmuraws",children:"Azure Kubernetes Service (AKS)"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://docs.github.com/actions/using-workflows/reusing-workflows",children:"Reusable workflows in GitHub Actions"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/azure/developer/github/connect-from-azure?tabs=azure-portal%2Cwindows&WT.mc_id=containers-84290-stmuraws",children:"Connecting GitHub Actions to Azure"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://kustomize.io/",children:"Kustomize"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://cli.github.com/",children:"GitHub CLI"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/Azure-Samples/eShopOnAKS",children:"eShopOnAKS"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>s});var i=t(67294);const r={},a=i.createContext(r);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);