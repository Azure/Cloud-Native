"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4085],{90321:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var r=n(85893),a=n(11151);const i={date:"2024-03-19T09:00",slug:"forecasting-energy-usage-with-intelligent-apps-2",title:"2.2 Forecasting Energy Usage with Intelligent Apps Part 2",authors:["cnteam"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["Cloud-Scale","Data","AI","AI/ML","intelligent apps","cloud-native","60-days","enterprise apps","digital experiences","app modernization"],image:"https://github.com/Azure/Cloud-Native/blob/main/website/static/img/ogImage.png",description:"In this series, you\u2019ll create an Intelligent App powered by Azure Kubernetes Service (AKS) to forecast energy usage and cost.",tags:["Build-Intelligent-Apps","60-days-of-IA","learn-live","hack-together","community-buzz","ask-the-expert","azure-kubernetes-service","azure-functions","azure-openai","azure-container-apps","azure-cosmos-db","github-copilot","github-codespaces","github-actions"]},s=void 0,o={permalink:"/Cloud-Native/60DaysOfIA/forecasting-energy-usage-with-intelligent-apps-2",source:"@site/blog-60daysofIA/2024-03-19/forecasting-energy-usage-with-intelligent-apps-2.md",title:"2.2 Forecasting Energy Usage with Intelligent Apps Part 2",description:"In this series, you\u2019ll create an Intelligent App powered by Azure Kubernetes Service (AKS) to forecast energy usage and cost.",date:"2024-03-19T09:00:00.000Z",formattedDate:"March 19, 2024",tags:[{label:"Build-Intelligent-Apps",permalink:"/Cloud-Native/60DaysOfIA/tags/build-intelligent-apps"},{label:"60-days-of-IA",permalink:"/Cloud-Native/60DaysOfIA/tags/60-days-of-ia"},{label:"learn-live",permalink:"/Cloud-Native/60DaysOfIA/tags/learn-live"},{label:"hack-together",permalink:"/Cloud-Native/60DaysOfIA/tags/hack-together"},{label:"community-buzz",permalink:"/Cloud-Native/60DaysOfIA/tags/community-buzz"},{label:"ask-the-expert",permalink:"/Cloud-Native/60DaysOfIA/tags/ask-the-expert"},{label:"azure-kubernetes-service",permalink:"/Cloud-Native/60DaysOfIA/tags/azure-kubernetes-service"},{label:"azure-functions",permalink:"/Cloud-Native/60DaysOfIA/tags/azure-functions"},{label:"azure-openai",permalink:"/Cloud-Native/60DaysOfIA/tags/azure-openai"},{label:"azure-container-apps",permalink:"/Cloud-Native/60DaysOfIA/tags/azure-container-apps"},{label:"azure-cosmos-db",permalink:"/Cloud-Native/60DaysOfIA/tags/azure-cosmos-db"},{label:"github-copilot",permalink:"/Cloud-Native/60DaysOfIA/tags/github-copilot"},{label:"github-codespaces",permalink:"/Cloud-Native/60DaysOfIA/tags/github-codespaces"},{label:"github-actions",permalink:"/Cloud-Native/60DaysOfIA/tags/github-actions"}],readingTime:11.065,hasTruncateMarker:!1,authors:[{name:"#60Days Of IA",title:"BuildIA Content Team",url:"https://azure.github.io/Cloud-Native/Build-IA/",imageURL:"https://azure.github.io/Cloud-Native/img/logo-2024.png",key:"cnteam"}],frontMatter:{date:"2024-03-19T09:00",slug:"forecasting-energy-usage-with-intelligent-apps-2",title:"2.2 Forecasting Energy Usage with Intelligent Apps Part 2",authors:["cnteam"],draft:!1,hide_table_of_contents:!1,toc_min_heading_level:2,toc_max_heading_level:3,keywords:["Cloud-Scale","Data","AI","AI/ML","intelligent apps","cloud-native","60-days","enterprise apps","digital experiences","app modernization"],image:"https://github.com/Azure/Cloud-Native/blob/main/website/static/img/ogImage.png",description:"In this series, you\u2019ll create an Intelligent App powered by Azure Kubernetes Service (AKS) to forecast energy usage and cost.",tags:["Build-Intelligent-Apps","60-days-of-IA","learn-live","hack-together","community-buzz","ask-the-expert","azure-kubernetes-service","azure-functions","azure-openai","azure-container-apps","azure-cosmos-db","github-copilot","github-codespaces","github-actions"]},unlisted:!1,nextItem:{title:"4.5 Deploying Your Copilot On Azure",permalink:"/Cloud-Native/60DaysOfIA/deploying-your-copilot-on-azure"}},l={authorsImageUrls:[void 0]},c=[{value:"Forecasting Energy Usage with Intelligent Apps Part 2: Making Predictions",id:"forecasting-energy-usage-with-intelligent-apps-part-2-making-predictions",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Predicting Energy Consumption and Pricing with an Intelligent App",id:"predicting-energy-consumption-and-pricing-with-an-intelligent-app",level:3},{value:"Setting Up the Backend Service",id:"setting-up-the-backend-service",level:4},{value:"Building and Pushing to ACR",id:"building-and-pushing-to-acr",level:5},{value:"Connecting to AKS",id:"connecting-to-aks",level:5},{value:"Deployment",id:"deployment",level:5},{value:"Invoking the service",id:"invoking-the-service",level:5},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components},{Head:i}=t;return i||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(i,{children:[(0,r.jsx)("meta",{property:"og:url",content:"https://azure.github.io/cloud-native/60daysofia/forecasting-energy-usage-with-intelligent-apps-2"}),(0,r.jsx)("meta",{property:"og:type",content:"website"}),(0,r.jsx)("meta",{property:"og:title",content:"Build Intelligent Apps | AI Apps on Azure"}),(0,r.jsx)("meta",{property:"og:description",content:"In this series, you'll create an Intelligent App powered by Azure Kubernetes Service (AKS) to forecast energy usage and cost."}),(0,r.jsx)("meta",{property:"og:image",content:"https://github.com/Azure/Cloud-Native/blob/main/website/static/img/ogImage.png"}),(0,r.jsx)("meta",{name:"twitter:url",content:"https://azure.github.io/Cloud-Native/60daysofIA/forecasting-energy-usage-with-intelligent-apps-2"}),(0,r.jsx)("meta",{name:"twitter:title",content:"Build Intelligent Apps | AI Apps on Azure"}),(0,r.jsx)("meta",{name:"twitter:description",content:"In this series, you'll create an Intelligent App powered by Azure Kubernetes Service (AKS) to forecast energy usage and cost."}),(0,r.jsx)("meta",{name:"twitter:image",content:"https://azure.github.io/Cloud-Native/img/ogImage.png"}),(0,r.jsx)("meta",{name:"twitter:card",content:"summary_large_image"}),(0,r.jsx)("meta",{name:"twitter:creator",content:"@devanshidiaries"}),(0,r.jsx)("link",{rel:"canonical",href:"https://azure.github.io/Cloud-Native/60daysofIA/forecasting-energy-usage-with-intelligent-apps-2"})]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Graphic of a bar chart with a magnifying glass in front of it. To the left of the magnifying glass is a lightning bolt. At the bottom of the graphic is text that reads, &quot;Forecasting Energy Usage with Intelligent Apps: Making Predictions.&quot;",src:n(23489).Z+"",width:"624",height:"380"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.em,{children:"This three-part series demonstrates how to create an Intelligent App that forecasts future energy consumption and pricing based on historical data. In this second article, you\u2019ll build out an app that analyzes historical data on energy consumption to build a forecasting model that forecasts future energy usage/pricing based on parameters input by the user."})}),"\n",(0,r.jsx)(t.h2,{id:"forecasting-energy-usage-with-intelligent-apps-part-2-making-predictions",children:"Forecasting Energy Usage with Intelligent Apps Part 2: Making Predictions"}),"\n",(0,r.jsxs)(t.p,{children:["In ",(0,r.jsx)(t.a,{href:"https://azure.github.io/Cloud-Native/60DaysOfIA/forecasting-energy-usage-with-intelligent-apps-1",children:"Part 1 of this series"}),", you set up an ",(0,r.jsx)(t.a,{href:"https://azure.microsoft.com/products/kubernetes-service?ocid=buildia24_60days_blogs",children:"Azure Kubernetes Service"})," (AKS) cluster, installed ",(0,r.jsx)(t.a,{href:"https://azure.microsoft.com/updates/preview-ai-toolchain-operator-addon-for-aks/?ocid=buildia24_60days_blogs",children:"Kubernetes AI Toolchain Operator"})," (KAITO), and configured KAITO with Llama 2. In this article, you\u2019ll use the groundwork from Part 1 to build the Intelligent App."]}),"\n",(0,r.jsx)(t.p,{children:"Using historical data analysis and an open-source dataset, you\u2019ll construct a model capable of predicting future energy usage and pricing with the flexibility of user-defined parameters."}),"\n",(0,r.jsx)(t.p,{children:"Let\u2019s get started!"}),"\n",(0,r.jsx)(t.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(t.p,{children:"To follow this tutorial, ensure you:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Completed Part 1 of this series"}),"\n",(0,r.jsxs)(t.li,{children:["Have a Jupyter notebook or a preferred Python integrated development environment (IDE), like ",(0,r.jsx)(t.a,{href:"https://code.visualstudio.com/",children:"Visual Studio Code"}),", downloaded"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://kubernetes.io/docs/tasks/tools/",children:"kubectl"}),", the Kubernetes command-line tool, installed"]}),"\n",(0,r.jsxs)(t.li,{children:["The ",(0,r.jsx)(t.a,{href:"https://github.com/contentlab-io/Microsoft-Forecasting-Energy-Usage-with-Intelligent-Apps/tree/main/Part%202",children:"Forecast API source code"})," downloaded"]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["For a sneak peek of the final product, check out the ",(0,r.jsx)(t.a,{href:"https://github.com/contentlab-io/Microsoft-Forecasting-Energy-Usage-with-Intelligent-Apps/tree/main/Part%202",children:"complete project code"}),"."]}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["Checkout the ",(0,r.jsx)(t.a,{href:"https://aka.ms/learn-live-building-intelligent-apps-aks-ep3?ocid=buildia24_60days_blogs",children:"Intelligent Apps on AKS: Episode 3"}),", a technical deep dive hands-on training with an expert on how OpenCost, Prometheus, and Grafana with AKS can improve intelligent apps."]})}),"\n",(0,r.jsx)(t.h3,{id:"predicting-energy-consumption-and-pricing-with-an-intelligent-app",children:"Predicting Energy Consumption and Pricing with an Intelligent App"}),"\n",(0,r.jsxs)(t.p,{children:["The Intelligent App will analyze historical data on energy consumption to build a regression model. For this tutorial, you\u2019ll use an open-source ",(0,r.jsx)(t.a,{href:"https://www.kaggle.com/datasets/nicholasjhana/energy-consumption-generation-prices-and-weather",children:"Kaggle dataset"})," named \u201cHourly energy demand generation and weather.\u201d"]}),"\n",(0,r.jsx)(t.p,{children:"At a high level, you\u2019ll take the following steps to build the Intelligent App:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Dataset analysis and feature engineering"}),"\u2014You\u2019ll start by examining the dataset. For this tutorial, you want to understand the relationships between energy consumption, pricing, and influencing factors like time. You\u2019ll engineer new features from the raw data. This includes working hours, the day of the week, and the month."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Model training"}),"\u2014You\u2019ll use XGBoost as a suitable regression model, as it accounts for both time elements and external factors. You\u2019ll train it using the processed Kaggle dataset. The goal is to teach our model to identify patterns and make reliable predictions of electricity prices."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"User input"}),"\u2014The app will let users provide parameters, such as a date, time, amount of electricity generated from burning, and more. The model will use these inputs to generate predictions."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Report generation"}),"\u2014Llama2 will come into play here. It will help you create a clear and informative report summarizing the user\u2019s input, the model\u2019s predictions, and any insights derived from the analysis."]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Note:"})," To keep this article focused, we\u2019ll assume you have a pre-cleaned dataset with engineered features. If you\u2019d like to see the details of this process, ",(0,r.jsx)(t.a,{href:"https://github.com/contentlab-io/Microsoft-Forecasting-Energy-Usage-with-Intelligent-Apps/blob/main/Part%202/data/predicting-future-energy-pricing.ipynb",children:"refer to this notebook"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"With the steps above completed, you need to split the data into training and testing sets using the code below. Doing so allows you to predict \u201cprice actual\u201d \u2014 the target feature for this tutorial."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"# Define the target feature \r\ntarget = 'price actual' \r\n\r\n# Split data into feature matrix (X) and target vector (y) \r\nX, y = df.drop(columns=target), df[target] \r\n\r\n# Split the data into training and testing sets \r\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42) \n"})}),"\n",(0,r.jsx)(t.p,{children:"Next, use the code below to define a function to train your model."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"def train_xgboost_regressor(X_train, y_train, X_test, y_test): \r\n    \"\"\" \r\n    Train an XGBoost regressor using cross-validation, tune hyperparameters, and evaluate the model. \r\n\r\n    Parameters: \r\n    X_train (DataFrame): The DataFrame containing the training features. \r\n    y_train (Series): The Series containing the training target variable. \r\n    X_test (DataFrame): The DataFrame containing the testing features. \r\n    y_test (Series): The Series containing the testing target variable. \r\n\r\n    Returns: \r\n    float: Mean squared error (MSE) of the model. \r\n    float: R-squared (R2) score of the model. \r\n    \"\"\" \r\n\r\n    # Define the XGBoost regressor \r\n    xgb_regressor = xgb.XGBRegressor() \r\n\r\n    # Define parameter grid for hyperparameter tuning \r\n    param_grid = { \r\n        'learning_rate': [0.05, 0.1], \r\n        'max_depth': [3, 5, 7], \r\n        #'min_child_weight': [1, 3, 5], \r\n        #'subsample': [0.6, 0.8, 1.0], \r\n        #'colsample_bytree': [0.6, 0.8, 1.0], \r\n        #'gamma': [0, 0.1, 0.2] \r\n    }\r\n\r\n    # Perform GridSearchCV for hyperparameter tuning \r\n    grid_search = GridSearchCV(estimator=xgb_regressor, param_grid=param_grid, cv=5, scoring='neg_mean_squared_error', verbose=1) \r\n    grid_search.fit(X_train, y_train) \r\n\r\n    # Get the best parameters \r\n    best_params = grid_search.best_params_ \r\n\r\n    # Initialize XGBoost regressor with best parameters \r\n    best_xgb_regressor = xgb.XGBRegressor(**best_params) \r\n\r\n    # Perform cross-validation \r\n    cv_scores = cross_val_score(best_xgb_regressor, X_train, y_train, cv=5, scoring='neg_mean_squared_error') \r\n\r\n    # Train the XGBoost regressor on the full training set \r\n    best_xgb_regressor.fit(X_train, y_train) \r\n\r\n    # Make predictions on the test set \r\n    y_pred = best_xgb_regressor.predict(X_test) \r\n\r\n    # Save the model \r\n    save_model(best_xgb_regressor, 'xgb_model.joblib') \r\n\r\n    # Calculate MSE and R2 score \r\n    rmse = root_mean_squared_error(y_test, y_pred) \r\n    r2 = r2_score(y_test, y_pred) \r\n\r\n    return rmse, r2 \r\n\u202f \r\n\r\nrmse, r2 = train_xgboost_regressor(X_train, y_train, X_test, y_test) \r\nprint(\"Test RMSE:\", rmse) \r\nprint(\"Test R2 Score:\", r2) \n"})}),"\n",(0,r.jsx)(t.p,{children:"The output of the code snippet above should look like the following:"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Screenshot of output code in the terminal. It reads, &quot;Fitting 5 folds for each of 6 candidates, totalling 30 fits\r\nTest RMSW: 5.738308690044228\r\nTest R2 Score: 0.8378464489048971",src:n(57779).Z+"",width:"624",height:"55"})}),"\n",(0,r.jsx)(t.p,{children:"After fitting the model with cross-validation and hyperparameter tuning, you\u2019ll see an average root mean squared error (RMSE) of approximately 5.74 and an R-squared (R2) score of about 0.84 on the test data. So, the R-squared values show promising performance in predicting energy prices!"}),"\n",(0,r.jsx)(t.p,{children:"Next, you\u2019ll create the Forecast API, set up its communication with Llama2, and deploy it onto your AKS cluster."}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["Complete the ",(0,r.jsx)(t.a,{href:"https://aka.ms/intelligent-apps/apps-csc?ocid=buildia24_60days_blogs",children:"Intelligent Apps Skills Challenge"})," to compete for the leaderboard and earn a Microsoft Learn Badge."]})}),"\n",(0,r.jsx)(t.h4,{id:"setting-up-the-backend-service",children:"Setting Up the Backend Service"}),"\n",(0,r.jsxs)(t.p,{children:["In the sections that follow, you\u2019ll deploy a simple Python service named \u201cForecast API.\u201d This service will have an endpoint called ",(0,r.jsx)(t.code,{children:"predict-chat"})," that will interact with the Llama2 Chat inference service within your AKS cluster. But first, you\u2019ll set up a backend service."]}),"\n",(0,r.jsxs)(t.p,{children:["Unzip the ",(0,r.jsx)(t.a,{href:"https://github.com/contentlab-io/Microsoft-Forecasting-Energy-Usage-with-Intelligent-Apps/tree/main/Part%202",children:"source code"})," that accompanies this article. It contains the files necessary to run your Python API using the Flask library, including the following:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"Name \r\n---- \r\napp.py \r\ndeployment.yaml \r\nDockerfile \r\nrequirements.txt \r\nservice.yaml \n"})}),"\n",(0,r.jsxs)(t.p,{children:["Open the ",(0,r.jsx)(t.code,{children:"app.py"})," file:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"from flask import Flask, request, jsonify \r\nimport os \r\nimport requests \r\n\r\napp = Flask(__name__) \r\n\r\nGENERATE_ENDPOINT_CHAT = os.environ.get('GENERATE_ENDPOINT_CHAT') \r\n\r\n@app.route('/predict-chat', methods=['POST']) \r\ndef predict_chat(): \r\n    try: \r\n        data = request.get_json() \r\n\r\n        gen_fossil_brown_coal = data.get('gen_fossil_brown_coal') or 582.0 \r\n        gen_fossil_gas = data.get('gen_fossil_gas') or 5537.0 \r\n        gen_fossil_hard_coal = data.get('gen_fossil_hard_coal') or 4039.0 \r\n        gen_fossil_oil = data.get('gen_fossil_oil') or 331.0 \r\n        gen_hydro = data.get('gen_hydro') or 454.0 \r\n        gen_other_renewable = data.get('gen_other_renewable') or 97.0 \r\n        gen_wind_onshore = data.get('gen_wind_onshore') or 7556.0 \r\n        total_load_actual = data.get('total_load_actual') or 31648.0 \r\n        price = data.get('price') or 40.61 \r\n        max_gen_len = data.get('max_gen_len') or 1024 \r\n        temperature = data.get('temperature') or 0.0 \r\n\r\n        prompt = f\"\"\"Display the following report table based on user inputs in tabular text format and write a single-paragraph report summarizing the electricity usage and forecast price: \r\n\r\n        ### Table \r\n\r\n        Generation from fossil brown coal/lignite: {gen_fossil_brown_coal} MW \r\n        Generation from fossil gas: {gen_fossil_gas} MW \r\n        Generation from fossil hard coal:  {gen_fossil_hard_coal} MW \r\n        Generation from fossil oil: {gen_fossil_oil} MW \r\n        Generation from hydro pumped storage: {gen_hydro} MW \r\n        Generation from other renewable sources: {gen_other_renewable} MW \r\n        Generation from onshore wind: {gen_wind_onshore} MW \r\n\r\n        ### Totals: \r\n        Total actual load: {total_load_actual} MW \r\n\r\n        Forecast price: {price} EUR/MWh \r\n\r\n        ### Short analysis: \r\n        Please write a short analysis on the data above.\"\"\" \r\n\r\n        generate_response = requests.post(GENERATE_ENDPOINT_CHAT, json={ \r\n            \"input_data\": {\"input_string\":[[ {\"role\": \"user\", \"content\": prompt}]]}, \r\n            \"parameters\": {\"max_gen_len\": max_gen_len, \"temperature\": temperature} \r\n        }) \r\n\r\n        if generate_response.status_code == 200: \r\n            return generate_response.json(), 200 \r\n        else: \r\n            return jsonify({'error': 'Failed to invoke generate endpoint'}), 500 \r\n\r\n    except Exception as e: \r\n        return jsonify({'error': str(e)}), 500 \r\n\r\nif __name__ == '__main__': \r\n    app.run(debug=True) \n"})}),"\n",(0,r.jsxs)(t.p,{children:["Let\u2019s review what the code inside the ",(0,r.jsx)(t.code,{children:"app.py"})," file is doing."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["The ",(0,r.jsx)(t.code,{children:"app.py"})," file is an API endpoint for generating a report on electricity usage and forecasted price based on user-provided input data."]}),"\n",(0,r.jsxs)(t.li,{children:["When a POST request is received by the ",(0,r.jsx)(t.code,{children:"/predict-chat"})," endpoint, the application extracts the input data from the request, including parameters like generation from different energy sources, total actual load, price, and additional settings like ",(0,r.jsx)(t.code,{children:"max_gen_len"})," and ",(0,r.jsx)(t.code,{children:"temperature"}),". Note that for now, the app sends dummy values. In Part 3, you\u2019ll update your app to take real values from the user and predict the electricity price using the prediction model."]}),"\n",(0,r.jsxs)(t.li,{children:["Then, the app constructs a prompt containing the input data and sends a request to another endpoint, specified by the ",(0,r.jsx)(t.code,{children:"GENERATE_ENDPOINT_CHAT"})," environment variable, to generate a response. The response includes the report table in tabular text format and a short data analysis."]}),"\n",(0,r.jsx)(t.li,{children:"If the generation request is successful, the application returns a report produced with the generative capabilities of Llama 2 Chat, which is hosted as an inference service in your AKS cluster."}),"\n"]}),"\n",(0,r.jsx)(t.h5,{id:"building-and-pushing-to-acr",children:"Building and Pushing to ACR"}),"\n",(0,r.jsxs)(t.p,{children:["Run the following commands to build the image locally and push it to your Azure Container Registry (ACR). Be sure to replace username and password with your ",(0,r.jsx)(t.code,{children:"username"})," and ",(0,r.jsx)(t.code,{children:"password"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo docker build --no-cache -f Dockerfile -t forecast-api -t <YOUR-ACR-NAME>.azurecr.io/forecast-api:latest . \r\n\r\ndocker login <YOUR-ACR-NAME>.azurecr.io --username <username> --password-stdin <password> \r\n\r\ndocker push <YOUR-ACR-NAME>.azurecr.io/forecast-api:latest \n"})}),"\n",(0,r.jsx)(t.h5,{id:"connecting-to-aks",children:"Connecting to AKS"}),"\n",(0,r.jsx)(t.p,{children:"Start by making sure you\u2019re logged in to Azure and that you have the correct AKS credentials by running the following:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"az login --tenant <YOUR-AZURE-TENANT-ID> \n"})}),"\n",(0,r.jsx)(t.p,{children:"Next, run the following commands:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"export RESOURCE_GROUP=<YOUR-RESOURCE-GROUP> \r\nexport MY_CLUSTER=<YOUR-AKS-CLUSTER-NAME> \r\nexport LOCATION=<YOUR-LOCATION> \r\nexport SUBSCRIPTION=<YOUR-AZURE-SUBSCRIPTION> \r\n\r\naz account set --subscription $SUBSCRIPTION \r\naz aks get-credentials --resource-group $RESOURCE_GROUP --name $MY_CLUSTER \n"})}),"\n",(0,r.jsx)(t.h5,{id:"deployment",children:"Deployment"}),"\n",(0,r.jsx)(t.p,{children:"Before deploying, you need to retrieve the cluster IP of the Llama2 7B chat workspace running on your AKS cluster. Run the following command in your terminal:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"> kubectl get svc \n"})}),"\n",(0,r.jsx)(t.p,{children:"Copy the inference service\u2019s cluster IP:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"NAME                       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)            AGE \r\nworkspace-llama-2-7b-chat  ClusterIP   <CLUSTERIP>  <none>        80/TCP,29500/TCP   10m \n"})}),"\n",(0,r.jsxs)(t.p,{children:["Next, open the source code directory. Modify the ",(0,r.jsx)(t.code,{children:"deployment.yaml"})," file, replacing the ",(0,r.jsx)(t.code,{children:"WORKSPACE-LLAMA-CHAT-CLUSTER-IP"})," placeholder below with your inference service cluster IP you copied above:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'apiVersion: apps/v1 \r\nkind: Deployment \r\nmetadata: \r\n  name: forecast-api-deployment \r\nspec: \r\n  replicas: 1 \r\n  selector: \r\n    matchLabels: \r\n      app: forecast-api \r\n  template: \r\n    metadata: \r\n      labels: \r\n        app: forecast-api \r\n    spec: \r\n      containers: \r\n      - name: forecast-api \r\n        image: <YOUR-ACR-NAME>.azurecr.io/forecast-api:latest \r\n        ports: \r\n        - containerPort: 5000 \r\n        env: \r\n        - name: GENERATE_ENDPOINT_CHAT \r\n          value: "http://<WORKSPACE-LLAMA-CHAT-CLUSTER-IP>/chat" \n'})}),"\n",(0,r.jsxs)(t.p,{children:["Then, save the updated ",(0,r.jsx)(t.code,{children:"deployment.yaml"})," file."]}),"\n",(0,r.jsx)(t.p,{children:"Execute the following commands to deploy the service to your AKS cluster:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"snap install kubectl --classic \r\nkubectl apply -f deployment.yaml \r\nkubectl apply -f service.yaml \n"})}),"\n",(0,r.jsx)(t.h5,{id:"invoking-the-service",children:"Invoking the service"}),"\n",(0,r.jsx)(t.p,{children:"Now that the Forecast API service is deployed, try it out!"}),"\n",(0,r.jsx)(t.p,{children:"Run the command below and grab your Forecast API external IP:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"> kubectl get svc \r\n\r\nNAME                                 TYPE           CLUSTER-IP    EXTERNAL-IP   \r\nforecast-api-service                 LoadBalancer   <CLUSTER-IP>  <FORECAST-API-IP> \r\nworkspace-llama-2-7b-chat            ClusterIP      <CLUSTER-IP>  <none>        \r\nworkspace-llama-2-7b-chat-headless   ClusterIP      None          <none>  \n"})}),"\n",(0,r.jsxs)(t.p,{children:["Now, run the curl command below to test your Forecast API service. Be sure to replace the ",(0,r.jsx)(t.code,{children:"<FORECAST-API-IP>"})," placeholder with your Forecast API external IP:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'curl --location \'http://<FORECAST-API-IP>/predict-chat\' \\ \r\n--header \'Content-Type: application/json\' \\ \r\n--data \'{ \r\n    "gen_fossil_brown_coal": 582.0, \r\n    "gen_fossil_gas": 5537.0, \r\n    "gen_fossil_hard_coal": 4039.0, \r\n    "gen_fossil_oil": 331.0, \r\n    "gen_hydro": 454.0, \r\n    "gen_other_renewable": 97.0, \r\n    "gen_wind_onshore": 7556.0, \r\n    "total_load_actual": 31648.0, \r\n    "price": 40.61, \r\n    "max_seq_len": 0, \r\n    "max_gen_len": 2048, \r\n    "temperature": 0.5 \r\n}\' \n'})}),"\n",(0,r.jsx)(t.p,{children:"The Forecast API service will process the request containing the data from energy sources and price, invoke the inference service, and return the response to the user:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'"content": "Based on the user inputs provided, the following is the table of electricity generation and forecast price: \r\n\r\n| Generation Source | MW | \r\n| --- | --- | \r\n| Fossil Brown Coal/Lignite | 582.0 | \r\n| Fossil Gas | 5537.0 | \r\n| Fossil Hard Coal | 4039.0 | \r\n| Fossil Oil | 331.0 | \r\n| Hydro Pumped Storage | 454.0 | \r\n| Other Renewable Sources | 97.0 | \r\n| Onshore Wind | 7556.0 | \r\n\r\nTotal Actual Load | 31648.0 | \r\n\r\nForecast Price | 40.61 EUR/MWh | \r\n\r\nBased on the data provided, the electricity generation from various sources shows a predominance of fossil fuels, with fossil gas being the largest contributor at 5537.0 MW, followed by fossil hard coal at 4039.0 MW, and fossil brown coal/lignite at 582.0 MW. Onshore wind is the largest renewable source of electricity generation at 7556.0 MW.\n'})}),"\n",(0,r.jsx)(t.p,{children:"That\u2019s it! Note how the generative capabilities of Llama2 7B chat model can transform the cold numbers of your input into an intelligent analysis."}),"\n",(0,r.jsx)(t.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsx)(t.p,{children:"In this second installment of the series, you analyzed historical data, used a dataset to construct a model capable of predicting future energy pricing, and used LLaMA2 to generate a report on the energy usage. Continue to Part 3, where you\u2019ll build a basic web interface for the Intelligent App, display the report generated by model, and deploy the app."}),"\n",(0,r.jsxs)(t.p,{children:["To keep your learning going, participate in the ",(0,r.jsx)(t.a,{href:"https://aka.ms/intelligent-apps/csc",children:"Cloud Skill Challenges"}),", check out the ",(0,r.jsx)(t.a,{href:"https://aka.ms/intelligent-apps/ate-aks?ocid=buildia24_60days_blogs",children:"Ask The Expert session"})," with the AKS product team, and register for ",(0,r.jsxs)(t.strong,{children:["AKS ",(0,r.jsx)(t.a,{href:"https://aka.ms/aks-day",children:"Customer"})," and ",(0,r.jsx)(t.a,{href:"https://aka.ms/aks-lab-day",children:"Lab"})," Days"]})," at KubeCon EU to stay abreast of the latest developments in cloud technology."]})]})}function p(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},23489:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/2-2-1-5d5b7a390c60123a537e7ab426daafcc.png"},57779:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/2-2-2-fd8c7337125621030a8d3db77f8b5979.png"},11151:(e,t,n)=>{n.d(t,{Z:()=>o,a:()=>s});var r=n(67294);const a={},i=r.createContext(a);function s(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);