<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="alternate" type="application/rss+xml" href="/Cloud-Native/blog/rss.xml" title="Building Cloud Native Apps RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Cloud-Native/blog/atom.xml" title="Building Cloud Native Apps Atom Feed">




<script>!function(t,e,n,c,a,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/d61n997vq9",(s=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><title data-rh="true">20 posts tagged with &quot;30-days-of-serverless&quot; | Building Cloud Native Apps</title><meta data-rh="true" property="og:image" content="https://azure.github.io/Cloud-Native/img/ogImage.png"><meta data-rh="true" property="og:url" content="https://azure.github.io/Cloud-Native/blog/tags/30-days-of-serverless/page/9"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="20 posts tagged with &quot;30-days-of-serverless&quot; | Building Cloud Native Apps"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="twitter:url" content="https://azure.github.io/Cloud-Native/blog/14-dapr-aca-quickstart"><meta data-rh="true" name="twitter:title" content="#30DaysOfServerless: Azure Container Apps + Dapr"><meta data-rh="true" name="twitter:description" content="#30DaysOfServerless: Azure Container Apps + Dapr"><meta data-rh="true" name="twitter:image" content="https://azure.github.io/Cloud-Native/img/banners/post-kickoff.png"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="twitter:creator" content="@nitya"><meta data-rh="true" name="twitter:site" content="@AzureAdvocates"><link data-rh="true" rel="icon" href="/Cloud-Native/img/favicon.ico"><link data-rh="true" rel="alternate" href="https://azure.github.io/Cloud-Native/blog/tags/30-days-of-serverless/page/9" hreflang="en"><link data-rh="true" rel="alternate" href="https://azure.github.io/Cloud-Native/blog/tags/30-days-of-serverless/page/9" hreflang="x-default"><link data-rh="true" rel="canonical" href="https://azure.github.io/Cloud-Native/blog/14-dapr-aca-quickstart"><link rel="stylesheet" href="/Cloud-Native/assets/css/styles.775e7648.css">
<link rel="preload" href="/Cloud-Native/assets/js/runtime~main.2d35ab23.js" as="script">
<link rel="preload" href="/Cloud-Native/assets/js/main.e7046595.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#ffb900;color:#000000" role="banner"><div class="announcementBarContent_xLdY"><b> Take the <a href="https://docs.microsoft.com/learn/challenges?id=b950cd7a-d456-46ab-81ba-3bd1ad86dc1c&WT.mc_id=javascript-74010-ninarasi"><b>Cloud Skills Challenge!</b></a> - Give us <a href="https://github.com/azure/cloud-native"><b>üåü on GitHub</b></a> </b> </div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Cloud-Native/"><div class="navbar__logo"><img src="/Cloud-Native/img/logo.png" alt="Azure Cloud Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/Cloud-Native/img/logo.png" alt="Azure Cloud Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Cloud Native</b></a><a class="navbar__item navbar__link" href="/Cloud-Native/serverless-september/">üçÇ #ServerlessSeptember</a><a class="navbar__item navbar__link" href="/Cloud-Native/calendar/">Events</a><a href="https://aka.ms/serverless-september/videos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Videos</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Cloud-Native/blog">Blog</a><a href="https://github.com/Azure/Cloud-Native/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussions</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Sitemap</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/Cloud-Native/serverless-september/ServerlessHacks">1. Serverless Hacks</a></li><li><a class="dropdown__link" href="/Cloud-Native/serverless-september/CloudSkills">2. Cloud Skills Challenge</a></li><li><a class="dropdown__link" href="/Cloud-Native/serverless-september/ZeroToHero">3. Zero To Hero</a></li><li><a class="dropdown__link" href="/Cloud-Native/serverless-september/AskTheExpert">4. Ask The Expert</a></li><li><a class="dropdown__link" href="/Cloud-Native/serverless-september/CommunityBuzz">5. Community Buzz</a></li><li><a class="dropdown__link" href="/Cloud-Native/serverless-september/30DaysOfServerless">6. #30DaysOfServerless</a></li><li><a class="dropdown__link" href="/Cloud-Native/blog">7. Blog</a></li><li><a class="dropdown__link" href="/Cloud-Native/docs/videos/intro">8. Videos</a></li><li><a class="dropdown__link" href="/Cloud-Native/docs/resources/intro">9. Resources</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Archives</a><ul class="dropdown__menu"><li><a href="https://dev.to/azure/serverlessseptember-2020-content-collection-443k" target="_blank" rel="noopener noreferrer" class="dropdown__link">2020 Content<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://dev.to/azure/serverless-september-content-collection-2fhb" target="_blank" rel="noopener noreferrer" class="dropdown__link">2019 Content<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/azure/cloud-native" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent Articles</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/serverless-status-post">ServerlessSeptember In a Nutshell</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/29-azure-developer-cli">29. Code to Cloud with `azd`</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/28-where-am-i">28. Serverless + Power Platforms</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/zero2hero-func-07">üöÄ | Monitor + Troubleshoot Apps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/25-aca-java">25. Deploy Spring Boot App to ACA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/24-aca-dotnet">24. Deploy ASP.NET app to ACA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/21-cloudevents-via-event-grid">21. CloudEvents with Event Grid</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/20-events-graph">20. Integrate with Microsoft Graph</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/zero2hero-func-05">üöÄ | Error Handling w/ Apache Kafka</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/zero2hero-aca-06">üöÄ | Observability with ACA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/18-cloudmail">18. Logic Apps + Computer Vision</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/17-integrate-cosmosdb">17. Logic Apps + Cosmos DB</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/15-microservices-azure">15. ACA + Serverless On Azure</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/14-dapr-aca-quickstart">14. Build ACA with Dapr</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/13-aca-managed-id">13. Secrets + Managed Identity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/12-build-with-dapr">12. Build With Dapr!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/zero2hero-func-03">üöÄ | Use Custom Handlers For Go</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/zero2hero-aca-04">üöÄ | Journey to the Cloud With ACA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/11-scaling-container-apps">11. Scaling Container Apps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/microservices-10">10. Microservices Communication</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/09-aca-fundamentals">09. Hello, Azure Container Apps</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/08-functions-azure">08. Functions + Serverless On Azure</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/07-functions-python">07. Functions for Python Devs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/06-functions-dotnet">06. Functions for .NET Devs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/zero2hero-func-02">üöÄ | Durable Entities Walkthrough</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/zero2hero-aca-01">üöÄ | Go Cloud Native with ACA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/05-functions-js">05. Functions for JS Devs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/04-functions-java">04. Functions For Java Devs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/03-functions-quickstart">03. Build Your First Function</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/02-functions-intro">02. Learn Core Concepts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/01-kickoff">01. It&#x27;s 30DaysOfServerless!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/students">Welcome Students!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Cloud-Native/blog/welcome">Hello, ServerlessSeptember</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>20 posts tagged with &quot;30-days-of-serverless&quot;</h1><a href="/Cloud-Native/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://azure.github.io/Cloud-Native/assets/images/banner-7d7a40cad48fa26cd9b62cdf2a073fe5.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/Cloud-Native/blog/14-dapr-aca-quickstart">14. Build ACA with Dapr</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-09-14T00:00:00.000Z" itemprop="datePublished">September 14, 2022</time> ¬∑ <!-- -->21 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/tjoudeh" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/tjoudeh.png" alt="Taisser Joudeh"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tjoudeh" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Taisser Joudeh</span></a></div><small class="avatar__subtitle" itemprop="description">Modern Apps Consultant @Microsoft</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><hr><p>Welcome to <code>Day 14</code> of #30DaysOfServerless!</p><p>In the past few days we focused our attention on Azure Container Apps, building microservices-based solutions and learning related concepts like environments, networking and auto-scaling - before introducing the sidecar capability of Dapr. Today, we look at how Dapr and ACA work seamlessly together to simplify microservices development in the cloud.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-well-cover">What We&#x27;ll Cover<a class="hash-link" href="#what-well-cover" title="Direct link to heading">‚Äã</a></h2><ul><li>Dapr refresher</li><li>Application scenario we are covering today</li><li>Quickstart: Build your first ACA with Dapr</li><li>Exercise: Try this yourself!</li><li>What&#x27;s Next: Advanced scenario in 12-part series </li><li>Resources: For self-study!</li></ul><p><img loading="lazy" src="/Cloud-Native/assets/images/banner-7d7a40cad48fa26cd9b62cdf2a073fe5.png" width="1600" height="672" class="img_ev3q"></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-dapr">Introduction To Dapr<a class="hash-link" href="#introduction-to-dapr" title="Direct link to heading">‚Äã</a></h2><p>As developers, we are often tasked with create scalable resilient and distributed microservices, but face challenges such as recovering state after failures, establishing reliable communication between services, integrating with external resources and instrumenting distributed tracing for end-to-end solution observability. Dapr (Distributed Application Runtime) offers an approach for solving these common problems more easily. </p><p>Dapr provides its core capabilities as a set of <a href="https://docs.dapr.io/concepts/building-blocks-concept/" target="_blank" rel="noopener noreferrer">Building Blocks</a> as detailed in the introduction to dapr article released as a part of this series. Building Blocks provide consistent APIs that abstract away the implementation details to keep microservices code simple and portable.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="todays-app-scenario">Today&#x27;s App Scenario<a class="hash-link" href="#todays-app-scenario" title="Direct link to heading">‚Äã</a></h2><p>In this blog post we will create an Azure Container App which will act as an internal-only, background processor service. This service will not be accessible from the internet or from other services directly. We will also configure two Dapr building blocks (APIs): Pub/Sub and State Management. Let&#x27;s take a look at the architecture diagram below to have better understanding of what we are building:</p><p><img loading="lazy" alt="Diagram showing architecture of sample project" src="/Cloud-Native/assets/images/ACA-Tutorial-AsyncComm-0922-909e943512d388e21a69516efb153bdf.jpg" width="1222" height="735" class="img_ev3q"></p><p>Our service, <code>orders-processor</code>, will be processing messages published to an Azure Service Bus Topic named <code>orderreceivedtopic</code>. The Dapr Pub/Sub building block will be configured by providing a configuration file named <code>pubsub-svcbus.yaml</code> which contains all the needed information to establish the connection between the container app and the service bus topic. Once a message is consumed by the <code>orders-processor</code> service, it will store a copy of it in Azure Cosmos DB. To wire up Cosmos DB, we will use the Dapr State Store building block and a <code>statestore-cosmosdb.yaml</code> component.</p><p>Because we are leveraging Dapr, we will not introduce any SDK for Azure Service Bus nor Azure Cosmos DB; everything will be configured using the component files, so let&#x27;s jump into the code! :)</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Looking for Advanced scenarios?</div><div class="admonitionContent_S0QG"><p>This scenario is a simplified version of a detailed tutorial which covers more advanced scenarios, if you are interested you can check more <a href="https://bitoftech.net/2022/08/25/tutorial-building-microservice-applications-azure-container-apps-dapr/" target="_blank" rel="noopener noreferrer">Advanced scenarios on my blog.</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-aca-with-dapr">Build ACA with Dapr<a class="hash-link" href="#build-aca-with-dapr" title="Direct link to heading">‚Äã</a></h2><p>In today&#x27;s post, we&#x27;ll be using VS Code to build the app using ASP.NET Core 6.0. In the process, we&#x27;ll setup our development environment with the relevant command-line tools and VS Code extensions. In addition, we will use the Azure CLI to create the Azure resources which will be used in this solution.</p><p><em>Note: Completing this exercise may incur a a cost of a few USD based on your Azure subscription.</em></p><p>First, make sure you have your development environment setup and configured.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>PRE-REQUISITES</div><div class="admonitionContent_S0QG"><ol><li><strong>An Azure account with an active subscription</strong> - <a href="https://azure.microsoft.com/free/?ref=microsoft.com&amp;utm_source=microsoft.com&amp;utm_medium=docs&amp;utm_campaign=visualstudio" target="_blank" rel="noopener noreferrer">Create an account for free</a></li><li><strong>dotnet 6.0</strong> - <a href="https://dotnet.microsoft.com/download/dotnet/6.0" target="_blank" rel="noopener noreferrer">Install</a></li><li><strong>Docker Desktop</strong> - <a href="https://docs.docker.com/desktop/install/windows-install/" target="_blank" rel="noopener noreferrer">Install</a> </li><li><strong>Visual Studio Code</strong> - <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Install</a></li><li><strong>VS Code Docker extension</strong> - <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker" target="_blank" rel="noopener noreferrer">Install</a></li><li><strong>Dapr CLI. Details on installation on this post too</strong> - <a href="https://docs.dapr.io/getting-started/install-dapr-cli/" target="_blank" rel="noopener noreferrer">Install</a></li><li><strong>VS Code Dapr extension. Depends on Dapr CLI</strong> - <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-dapr" target="_blank" rel="noopener noreferrer">Install</a></li><li><strong>Azure CLI</strong> - <a href="https://docs.microsoft.com/cli/azure/install-azure-cli" target="_blank" rel="noopener noreferrer">Install</a></li></ol></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-service-project-web-api">Create the service project (Web API)<a class="hash-link" href="#create-the-service-project-web-api" title="Direct link to heading">‚Äã</a></h3><ol><li><p>Open a command-line terminal and create a folder for your project. Use the <code>code</code> command to launch Visual Studio Code from that directory as shown:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir orders-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd orders-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">code .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>From VS Code Terminal tab, open developer command prompt or PowerShell terminal in the project folder <code>orders-service</code> and initialize the project by typing: <code>dotnet new webapi -o Orders.Processor  --no-https</code> This will create and ASP.NET Web API project scaffolded with 1 single controller. </p></li><li><p>We need to containerize this application so we can push it to Azure Container Registry as a docker image and deploy it to Azure Container Apps. To do so, Open the VS Code Command Palette (<kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>p</kbd>) and select <code>Docker: Add Docker Files to Workspace...</code></p><ul><li>Use <code>.NET: ASP.NET Core</code> when prompted for application platform.</li><li>Choose <code>Linux</code> when prompted to choose the operating system.</li><li>You will be asked if you want to add Docker Compose files. Select <code>No</code>.</li><li>Take a not of the provided <strong>application port</strong> as we will be using later on.</li><li><code>Dockerfile</code> and <code>.dockerignore</code> files are added to the workspace.</li></ul></li><li><p>Now we will add the DTO which will be used to deserialize the consumed message from Azure Service Bus Topic, so add a new file named <code>OrderModel.cs</code> under a new folder named <code>Models</code> and use the code below</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid OrderId { get; set; } = Guid.NewGuid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Reference { get; set; } = string.Empty;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int Quantity { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DateTime CreatedOn { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Install Dapr Client NuGet package, we will use this package to subscribe to the Azure Service Bus Topic in a programmatic way. From the developer command prompt or PowerShell terminal type <code>dotnet add package Dapr.AspNetCore</code></p></li><li><p>Create an API endpoint for the consumer/service to subscribe to the topic, this endpoint will start receiving the messages published to the topic <code>orderreceivedtopic</code>. Add a new controller named <code>ExternalOrdersController.cs</code> under the <code>Controllers</code> folder and use the code below:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[ApiController]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Route(&quot;api/externalorders&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ExternalOrdersController : ControllerBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly ILogger&lt;ExternalOrdersController&gt; _logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly DaprClient _daprClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ExternalOrdersController(ILogger&lt;ExternalOrdersController&gt; logger, DaprClient daprClient)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _daprClient = daprClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [Topic(&quot;pubsub-servicebus&quot;, &quot;orderreceivedtopic&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [HttpPost(&quot;orderreceived&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task&lt;IActionResult&gt; OrderReceived([FromBody] OrderModel orderModel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _logger.LogInformation(&quot;Received new order at: &#x27;{0}&#x27; Order Id: &#x27;{1}&#x27; Order reference: &#x27;{2}&#x27;, Order quantity: &#x27;{3}&#x27;&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                DateTime.UtcNow, orderModel.OrderId, orderModel.Reference, orderModel.Quantity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Do your business logic with order received</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderModel.CreatedOn = DateTime.UtcNow;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ////ToDo: Your exercise :) Save the received message into CosmoDb using the SveStateAsync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //await _daprClient.SaveStateAsync&lt;OrderModel&gt;(&quot;statestore-cosmosdb&quot;, orderModel.OrderId.ToString(), orderModel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Return 200 ok to acknowledge order is processed successfully          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Ok($&quot;Order Processing completed successfully&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Retunr 400 bad request to retry re-processing based on service broker configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //return BadRequest($&quot;Failed to process order due to: failure reason&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In summary, the above steps result in: </p><ul><li>An action method called <code>orderreceived</code> which can be reached on the route <code>api/externalorders/orderreceived</code> and receives an <code>OrderModel</code> object.</li><li>An attribute <code>Topic</code> on the action method including the name of the pub/sub component and the topic to subscribe to. </li><li>Business logic for processing the message which will result in an appropriate response which dictates if the message was process successfully, should be retried or should be dead-lettered.</li></ul></li><li><p>Register the Dapr client and Subscribe handler at service startup. Open the file <code>Program.cs</code> and replace with the content below:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    var builder = WebApplication.CreateBuilder(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Add services to the container.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.Services.AddControllers().AddDapr();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.Services.AddEndpointsApiExplorer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.Services.AddSwaggerGen();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var app = builder.Build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Configure the HTTP request pipeline.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (app.Environment.IsDevelopment())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.UseSwagger();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.UseSwaggerUI();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.UseAuthorization();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.UseCloudEvents();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.MapControllers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.MapSubscribeHandler();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.Run();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Want to know more?</div><div class="admonitionContent_S0QG"><p>   Check this <a href="https://bitoftech.net/2022/09/02/azure-container-apps-async-communication-with-dapr-pub-sub-api-part-6/" target="_blank" rel="noopener noreferrer">blog post</a> which describes in detail how the consumer was able to discover available topic names, Pub/Sub names, and which routes/endpoints to push messages to.</p></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="provision-azure-service-bus-topic-and-subscription">Provision Azure Service Bus, Topic and Subscription<a class="hash-link" href="#provision-azure-service-bus-topic-and-subscription" title="Direct link to heading">‚Äã</a></h3><p>We need to create the Azure Service Bus so we can configure the Dapr Pub/Sub component and test locally</p><ol><li><p>Open your Powershell console and login to Azure by using the command <code>az login</code>. If you have multiple subscriptions, set the subscription you want to use in this tutorial before proceeding, you can do this by using <code>az account set --subscription &lt;name or id&gt;</code>. Calling <code>az upgrade</code> is a good practice to ensure you are running the latest Aure CLI version.</p></li><li><p>Create an Azure Resource Group by using the code below, feel free to change the name and location of the resource group</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$RESOURCE_GROUP=&quot;orders-services-rg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$LOCATION=&quot;eastus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az group create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --location &quot;$LOCATION&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Create the necessary Azure Service Bus resource and retrieve the primary connection string (for local dev testing).</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$NamespaceName=&quot;ordersservices&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$TopicName=&quot;orderreceivedtopic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$TopicSubscription=&quot;orders-processor-subscription&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##Create servicebus namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az servicebus namespace create --resource-group $RESOURCE_GROUP --name $NamespaceName --location $LOCATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##Create a topic under namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az servicebus topic create --resource-group $RESOURCE_GROUP --namespace-name $NamespaceName --name $TopicName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##Create a topic subscription</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az servicebus topic subscription create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --namespace-name $NamespaceName `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --topic-name $TopicName `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name $TopicSubscription</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##List connection string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az servicebus namespace authorization-rule keys list --resource-group $RESOURCE_GROUP --namespace-name $NamespaceName --name RootManageSharedAccessKey --query primaryConnectionString --output tsv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>You can navigate to the Azure Portal and check that the resource group is created and the service bus namespace is created too.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setup-dapr-for-local-dev">Setup Dapr for local dev<a class="hash-link" href="#setup-dapr-for-local-dev" title="Direct link to heading">‚Äã</a></h3><p>In order to run Dapr locally on our development machine, we need to install Dapr CLI, you can follow the <a href="https://docs.dapr.io/getting-started/install-dapr-cli/" target="_blank" rel="noopener noreferrer">official documentation</a> or use the steps below.</p><ol><li><p>Install the Dapr CLI, run PowerShell console as an administrator and run the below command: </p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> powershell -Command &quot;iwr -useb https://raw.githubusercontent.com/dapr/cli/master/install/install.ps1 | iex&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: You might need to execute the following  PowerShell command <code>Set-ExecutionPolicy RemoteSigned -scope CurrentUser</code> before installing the Dapr CLI, this command is to allow local PowerShell scripts to run regardless of signature, and requires trusted digital signatures only for remote scripts.</p></li><li><p>Initialize Dapr in your local development environment. By initializing Dapr, we will fetch and install the Dapr sidecar binaries locally, and we will create a development environment that streamlines application development with Dapr. To do so open the PowerShell console as an administrator and run the below command:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dapr init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To verify the deployment; check Dapr version by running the following command: <code>dapr --version</code> </p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Want to know more?</div><div class="admonitionContent_S0QG"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Check this [blog post](https://bitoftech.net/2022/08/29/dapr-integration-with-azure-container-apps/) which describes in detail what components added to your machine when we called `dapr init`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-a-local-dapr-component-file-for-pubsub">Create a local Dapr Component file for Pub/Sub<a class="hash-link" href="#create-a-local-dapr-component-file-for-pubsub" title="Direct link to heading">‚Äã</a></h3><p>Dapr uses a modular design where functionality is delivered as a component. Each component has an interface definition. All of the components are pluggable so that you can swap out one component with the same interface for another.</p><p>Components are configured at design-time with a YAML file which is stored in either a components/local folder within your solution, or globally in the .dapr folder created when invoking dapr init <a href="https://bitoftech.net/2022/08/29/dapr-integration-with-azure-container-apps/" target="_blank" rel="noopener noreferrer">(read here for more details)</a>. These YAML files adhere to the generic <a href="https://docs.dapr.io/operations/components/component-schema/" target="_blank" rel="noopener noreferrer">Dapr component schema</a>, but each is specific to the component specification.</p><ol><li><p>Create 2 new folders under the project root directory <code>orders-service</code>, one called <code>dapr-component</code> and the second one <code>component</code> (will be used in next steps). Add a new yaml file called <code>pubsub-svcbus.yaml</code> under folder <code>dapr-component</code> using the content below:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dapr.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pubsub</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">servicebus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pubsub.azure.servicebus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> connectionString </span><span class="token comment" style="color:#999988;font-style:italic"># Used for local dev testing.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;connection string from step 2.3&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consumerID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;orders-processor-subscription&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scopes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> orders</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">processor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that we used the name <code>pubsub-servicebus</code> which should match the name of Pub/Sub component we&#x27;ve used earlier in the <code>ExternalOrdersController.cs</code> controller on the action method with the attribute <code>Topic</code>. As well we have set the metadata (key/value) to allow us to connect to Azure Service Bus topic. The metdata <code>consumerID</code> value should match the topic subscription name <code>orders-processor-subscription</code>. We have set the scopes section to include the <code>orders-processor</code> app id, as this will be the specific application that needs access to Azure Service Bus.</p><p>You need to replace the <code>connectionString</code> value with your Service Bus connection string. This is only needed for your local testing on your development machine, we&#x27;ll be using a different approach (<strong>Managed Identities</strong>) when deploying Dapr component to Azure Container Apps Environment. For full metadata specs, you can <a href="https://docs.dapr.io/reference/components-reference/supported-pubsub/setup-azure-servicebus/" target="_blank" rel="noopener noreferrer">check this page</a>.</p><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">The above sample uses secrets as plain strings for local dev testing. It is recommended to use Managed Identities approach when we deploy the app to Azure Container Apps. Your Dapr components directory should be added to your .gitignore to avoid checking in secrets.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="preview-dapr-app-locally-for-e2e-testing">Preview Dapr app locally for e2e testing<a class="hash-link" href="#preview-dapr-app-locally-for-e2e-testing" title="Direct link to heading">‚Äã</a></h3><ol><li><p>Within VS Code, open PowerShell terminal, change the directory in the terminal to folder <code>orders-service</code> and run the below command in PS terminal:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dapr run --app-id orders-processor --app-port 5039 --dapr-http-port 3500 --components-path &quot;../dapr-components&quot; dotnet run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When using the <code>dapr run</code> command we are running a dapr process as a sidecar next to the Web API application. The following properties were configured:</p><ul><li>app-id: The unique identifier of the application. Used for service discovery, state encapsulation, and the pub/sub consumer identifier.</li><li>app-port: This parameter tells Dapr which port your application is listening on, you can get the app port from <code>dockerfile</code> in the Web API Project.</li><li>dapr-http-port: the HTTP port for Dapr to listen on.</li><li>components-path: path to the Dapr component(s) folder.</li></ul><p>If all is working as expected, you can open the VS Code Dapr extension to see the application <code>orders-processor</code> up and running as shown below:</p><p><img loading="lazy" alt="Image showing Dapr Application up and Running" src="/Cloud-Native/assets/images/DaprRunning-792ed943c5235ef05dede830b5e4d317.jpg" width="406" height="450" class="img_ev3q"></p></li><li><p>To publish a message to the topic <code>orderreceivedtopic</code> we can use Dapr extension: </p><ul><li>Right click on the Dapr application <code>orders-processor</code> and select <code>Publish Message to Application</code>.</li><li>Wizard will ask what is the Pub/sub component name you want to publish to, provide <code>pubsub-servicebus</code> and hit enter.</li><li>Wizard will ask what topic name to publish to, provide <code>orderreceivedtopic</code> and hit enter.</li><li>Wizard will ask to provide a JSON payload for the method, provide the JSON below and hit enter.<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;reference&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Order 1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;quantity&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;createdOn&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2022-08-19T12:45:22.0983978Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ol><p>To check the results, go to the VS Code terminal and check the logs. In the action method, we are logging information when a message is consumed. You should see something similar to the below
<img loading="lazy" alt="Image showing logs in terminal" src="/Cloud-Native/assets/images/TerminalLogs-4813eaba2150ac7a867dafd58ba5dbfc.jpg" width="1444" height="161" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">:::info Want to debug Dapr application locally?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  If you want to set breakpoints and debug your daper application locally, you can do this in VS code by following simple steps. This is very important when you are running multiple services together and want to test your microservice where multi-services are invoking each other. To learn more, you can continue reading on [my blog.](https://bitoftech.net/2022/08/29/dapr-integration-with-azure-container-apps/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:::</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-the-app-to-azure-container-apps">Deploy the app to Azure Container Apps<a class="hash-link" href="#deploy-the-app-to-azure-container-apps" title="Direct link to heading">‚Äã</a></h3><p>We will follow few steps in order to deploy the service <code>Orders.Processor</code> to Azure Container Apps, but we need to do one addition before deploying, we have to create a component file for Azure Service Bus which meets the <a href="https://docs.microsoft.com/azure/container-apps/dapr-overview?tabs=bicep1%2Cyaml#configure-dapr-components" target="_blank" rel="noopener noreferrer">specs defined by Azure Container Apps</a>.</p><ol><li>Create a new yaml file named <code>pubsub-svcbus.yaml</code> and add it under folder <code>components</code> (folder created earlier), use the file content below:<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># pubsub.yaml for Azure Service Bus component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">componentType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pubsub.azure.servicebus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> namespaceName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ordersservices.servicebus.windows.net&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consumerID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;orders-processor-subscription&quot;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Application scopes  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scopes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> orders</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">processor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>Things to notice here:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  - We didn&#x27;t specify the component name `pubsub-servicebus` when we created this component file, we are going to specify it once we add this dapr component to Azure Container Apps Environment via CLI.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - We are not referencing any service bus connection strings as the authentication between Dapr and Azure Service Bus will be configured using Managed Identities. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - The metadata `namespaceName` value is set to the address of the Service Bus namespace as a fully qualified domain name. The key is mandatory when using Managed Identities for authentication.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - We are setting the metadata `consumerID` value to match the topic subscription name `orders-processor-subscription`. If you didn&#x27;t set this metadata, dapr runtime will try to create a subscription using the dapr application ID.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li><p>Createan  Azure Container Registry (ACR) instance in the resource group to build/push and store docker images of our service. Feel free to change the name of the ACR, to do so run the following command:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ## Create Azure Container Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $ACR_NAME=&quot;ordersservicesacr&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  az acr create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --name $ACR_NAME `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --sku Basic `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --admin-enabled true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Build the Web API project on ACR and push the docker image to ACR. Use the below command to initiate the image build and push process using ACR:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Build and push image to ACR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$BACKEND_SVC_NAME=&quot;orders-processor&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd {YourLocalPath}\orders-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az acr build --registry $ACR_NAME --image $BACKEND_SVC_NAME --file &#x27;Orders.Processor/Dockerfile&#x27; .      </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Provision an Azure Container Apps Env and Container App: the Azure Container Apps Environment acts as a secure boundary around a group of all container apps:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Upgrade az container app cli or install it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  az extension add --name containerapp --upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## Create ACA Env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $ENVIRONMENT=&quot;orders-services-aca-env&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  az containerapp env create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --name $ENVIRONMENT `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --location $LOCATION</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Deploy the Dapr Pub/Sub Component to the Azure Container Apps Environment using the following command: </p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    az containerapp env dapr-component set `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --name $ENVIRONMENT --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --dapr-component-name pubsub-servicebus `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --yaml &#x27;.\components\pubsub-svcbus.yaml&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Create a new Azure Container App with the below capabilities:</p><ul><li>Ingress should be disabled</li><li>Dapr needs to be enabled </li></ul><p>To achieve the above run the below PowerShell script:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## Create Azure COntain App</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$BACKEND_SVC_NAME=&quot;orders-processor&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az containerapp create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name $BACKEND_SVC_NAME  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --environment $ENVIRONMENT `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --registry-server &quot;$ACR_NAME.azurecr.io&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image &quot;$ACR_NAME.azurecr.io/$BACKEND_SVC_NAME&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --min-replicas 1 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --max-replicas 1 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cpu 0.50 --memory 1.0Gi `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-dapr `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --dapr-app-id  $BACKEND_SVC_NAME `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --dapr-app-port 5039</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-managed-identities-in-azure-container-app">Configure Managed Identities in Azure Container App<a class="hash-link" href="#configure-managed-identities-in-azure-container-app" title="Direct link to heading">‚Äã</a></h3><p>As you noticed so far, we are not using any connection strings to establish the relation between our Container App and Azure Service Bus, we will rely on <a href="https://learn.microsoft.com/azure/container-apps/managed-identity?tabs=portal%2Cdotnet" target="_blank" rel="noopener noreferrer">Managed Identities</a> to allow our container app to access Azure Service Bus. </p><p>We will be using a <code>system-assigned</code> identity with a role assignments to grant our container app the <code>Azure Service Bus Data Receiver</code> role which will allow it to receive messages from Service Bus queues and subscriptions.</p><ol><li><p>Run the command below to create <code>system-assigned</code> identity for our container app:</p><div class="language-PowerShell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-PowerShell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">##assigning the system assigned identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az containerapp identity assign `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name $BACKEND_SVC_NAME `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --system-assigned</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This command will create an Enterprise Application (so a Service Principal) within Azure AD, which is linked to our container app, the output of this command will be as the below, keep a note of the property <code>principalId</code> as we are going to use it in the next step.</p><div class="language-Json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;principalId&quot;: &quot;456782b0-d5be-4dbd-afa0-5e2cff05d04d&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;tenantId&quot;: &quot;0a02a8b1-XXXX-XXXX-XXXX-67ceb9132d81&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;type&quot;: &quot;SystemAssigned&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: This can be done from Azure Portal as described <a href="https://learn.microsoft.com/azure/container-apps/managed-identity?tabs=portal%2Cdotnet#add-a-system-assigned-identity" target="_blank" rel="noopener noreferrer">here.</a></p></li><li><p>Next, we need to associate the container app system-identity with the target Azure Service Bus resouce. You can read more about <a href="https://learn.microsoft.com/azure/service-bus-messaging/service-bus-managed-service-identity#azure-built-in-roles-for-azure-service-bus" target="_blank" rel="noopener noreferrer">Azure built-in roles for Azure Service Bus.</a>. Run the command below to associate the <code>system-assigned</code> with access-control role <code>Azure Service Bus Data Receiver</code></p><div class="language-PowerShell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-PowerShell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $subscription_id = &quot;&lt;Your Azure Subscription ID&gt;&quot; ## Your Azure Subscription</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $principalId = &quot;456782b0-d5be-4dbd-afa0-5e2cff05d04d&quot; ## Principal Id after creating system identity for container app </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $roleNameOrId =  &quot;Azure Service Bus Data Receiver&quot; ## Built in role name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $resourceName = &quot;ordersservices&quot; ##Name of your Service Bus Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  az role assignment create `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --assignee $principalId `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --role $roleNameOrId `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --scope /subscriptions/$subscription_id/resourcegroups/$RESOURCE_GROUP/providers/Microsoft.ServiceBus/namespaces/$resourceName</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> You can verify from Azure Portal that the association relation is created by going to your container app, select <code>identity</code> tab, then click on <code>Azure role assignments</code> button, you should see the role assignment below:
<img loading="lazy" alt="Image showing container apps role assignment" src="/Cloud-Native/assets/images/RoleAssignment-S-4d69197e34696dc635708ccffc9bbe66.jpg" width="855" height="338" class="img_ev3q"></p></li><li><p>Lastly, we need to restart the container app revision, to do so run the command below:</p><div class="language-PowerShell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-PowerShell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> ##Get revision name and assign it to a variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> $REVISION_NAME = (az containerapp revision list `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         --name $BACKEND_SVC_NAME  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         --query [0].name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ##Restart revision by name                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> az containerapp revision restart `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   --resource-group $RESOURCE_GROUP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   --name $BACKEND_SVC_NAME  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   --revision $REVISION_NAME</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="run-end-to-end-test-on-azure">Run end-to-end Test on Azure<a class="hash-link" href="#run-end-to-end-test-on-azure" title="Direct link to heading">‚Äã</a></h3><p>From the Azure Portal, select the Azure Container App <code>orders-processor</code> and navigate to <code>Log stream</code> under <code>Monitoring</code> tab, leave the stream connected and opened. From the Azure Portal, select the Azure Service Bus Namespace <code>ordersservices</code>, select the topic <code>orderreceivedtopic</code>, select the subscription named <code>orders-processor-subscription</code>, then click on <code>Service Bus Explorer (preview)</code>. From there we need to publish/send a message. Use the JSON payload below</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">```json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;data&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;reference&quot;: &quot;Order 150&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;quantity&quot;: 150,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;createdOn&quot;: &quot;2022-05-10T12:45:22.0983978Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> If all is configured correctly, you should start seeing the information logs in Container Apps Log stream, similar to the images below
<img loading="lazy" alt="Image showing publishing messages from Azure Service" src="/Cloud-Native/assets/images/SvsBusPublishMessage-S-db3c800138a71f277bc45fcdab54e297.jpg" width="669" height="344" class="img_ev3q"></p><p> Information logs on the <code>Log stream</code> of the deployed Azure Container App
<img loading="lazy" alt="Image showing ACA Log Stream" src="/Cloud-Native/assets/images/ACA-Logstream-s-93516646409771be6bbdeac37155df15.jpg" width="686" height="394" class="img_ev3q"></p><div class="theme-admonition theme-admonition-success alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>üéâ CONGRATULATIONS</div><div class="admonitionContent_S0QG"><p>You have successfully deployed to the cloud an Azure Container App and configured Dapr Pub/Sub API with Azure Service Bus.</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="9-clean-up">9. Clean up<a class="hash-link" href="#9-clean-up" title="Direct link to heading">‚Äã</a></h3><p>If you are done with the tutorial, use the following command to delete the resource group and all its contained resources to avoid incurring further costs.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">az group delete --name $RESOURCE_GROUP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exercise">Exercise<a class="hash-link" href="#exercise" title="Direct link to heading">‚Äã</a></h2><p>I left for you the configuration of the Dapr State Store API with Azure Cosmos DB :) </p><p>When you look at the action method <code>OrderReceived</code> in controller <code>ExternalOrdersController</code>, you will see that I left a line with <code>ToDo:</code> note, this line is responsible to save the received message (OrderModel) into Azure Cosmos DB. </p><p>There is no need to change anything on the code base (other than removing this commented line), that&#x27;s the beauty of Dapr Building Blocks and how easy it allows us to plug components to our microservice application without any plumping and brining external SDKs.</p><p>For sure you need to work on the configuration part of Dapr State Store by creating a new component file like what we have done with the Pub/Sub API, things that you need to work on are:</p><ul><li>Provision Azure Cosmos DB Account and obtain its masterKey.</li><li>Create a Dapr Component file adhering to Dapr Specs.</li><li>Create an Azure Container Apps component file adhering to ACA component specs.</li><li>Test locally on your dev machine using Dapr Component file.</li><li>Register the new Dapr State Store component with Azure Container Apps Environment and set the Cosmos Db masterKey from the Azure Portal. <em>If you want to challenge yourself more, use the Managed Identity approach as done in this post! The right way to protect your keys and you will not worry about managing CosmosDb keys anymore!</em></li><li>Build a new image of the application and push it to Azure Container Registry.</li><li>Update Azure Container Apps and create a new revision which contains the updated code.</li><li>Verify the results by checking Azure Cosmos DB, you should see the Order Model stored in Cosmos DB.</li></ul><p>If you need help, you can always refer to my blog post <a href="https://bitoftech.net/2022/08/29/azure-container-apps-state-store-with-dapr-state-management-api/" target="_blank" rel="noopener noreferrer">Azure Container Apps State Store With Dapr State Management API</a> which contains exactly what you need to implement here, so I&#x27;m very confident you will be able to complete this exercise with no issues, happy coding :)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next">What&#x27;s Next?<a class="hash-link" href="#whats-next" title="Direct link to heading">‚Äã</a></h2><p>If you enjoyed working with Dapr and Azure Container Apps, and you want to have a deep dive with more complex scenarios (Dapr bindings, service discovery, auto scaling with KEDA, sync services communication, distributed tracing, health probes, etc...) where multiple services deployed to a single Container App Environment; I have created a detailed tutorial which should walk you through step by step with through details to build the application.</p><p>So far, the published posts below, and I&#x27;m publishing more posts on weekly basis, so stay tuned :)</p><ul><li><a href="https://bitoftech.net/2022/08/25/tutorial-building-microservice-applications-azure-container-apps-dapr/" target="_blank" rel="noopener noreferrer">Tutorial for building Microservice Applications with Azure Container Apps and Dapr ‚Äì Part 1</a></li><li><a href="https://bitoftech.net/2022/08/25/deploy-microservice-application-azure-container-apps/" target="_blank" rel="noopener noreferrer">Deploy backend API Microservice to Azure Container Apps ‚Äì Part 2</a></li><li><a href="https://bitoftech.net/2022/08/25/communication-microservices-azure-container-apps/" target="_blank" rel="noopener noreferrer">Communication between Microservices in Azure Container Apps ‚Äì Part 3</a></li><li><a href="https://bitoftech.net/2022/08/29/dapr-integration-with-azure-container-apps/" target="_blank" rel="noopener noreferrer">Dapr Integration with Azure Container Apps ‚Äì Part 4</a></li><li><a href="https://bitoftech.net/2022/08/29/azure-container-apps-state-store-with-dapr-state-management-api/" target="_blank" rel="noopener noreferrer">Azure Container Apps State Store With Dapr State Management API ‚Äì Part 5</a></li><li><a href="https://bitoftech.net/2022/09/02/azure-container-apps-async-communication-with-dapr-pub-sub-api-part-6/" target="_blank" rel="noopener noreferrer">Azure Container Apps Async Communication with Dapr Pub/Sub API ‚Äì Part 6</a></li><li><a href="https://bitoftech.net/2022/09/05/azure-container-apps-with-dapr-bindings-building-block/" target="_blank" rel="noopener noreferrer">Azure Container Apps with Dapr Bindings Building Block ‚Äì Part 7</a></li><li><a href="https://bitoftech.net/2022/09/09/azure-container-apps-monitoring-and-observability-with-application-insights-part-8/" target="_blank" rel="noopener noreferrer">Azure Container Apps Monitoring and Observability with Application Insights ‚Äì Part 8</a></li><li><a href="https://bitoftech.net/2022/09/13/continuous-deployment-for-azure-container-apps-using-github-actions-part-9/" target="_blank" rel="noopener noreferrer">Continuous Deployment for Azure Container Apps using GitHub Actions ‚Äì Part 9</a></li><li><a href="https://bitoftech.net/2022/09/16/use-bicep-to-deploy-dapr-microservices-apps-to-azure-container-apps-part-10/" target="_blank" rel="noopener noreferrer">Use Bicep to Deploy Dapr Microservices Apps to Azure Container Apps ‚Äì Part 10</a></li><li><a href="https://bitoftech.net/2022/09/22/azure-container-apps-auto-scaling-with-keda-part-11/" target="_blank" rel="noopener noreferrer">Azure Container Apps Auto Scaling with KEDA ‚Äì Part 11</a></li><li><em>Integrate Health probes in Azure Container Apps ‚Äì Part 12</em></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">‚Äã</a></h2><ul><li><a href="https://docs.microsoft.com/azure/container-apps/" target="_blank" rel="noopener noreferrer">Azure Container Apps documentation</a></li><li><a href="https://docs.dapr.io/getting-started/" target="_blank" rel="noopener noreferrer">Getting started with Dapr</a></li><li><a href="https://docs.microsoft.com/dotnet/architecture/dapr-for-net-developers/" target="_blank" rel="noopener noreferrer">Dapr for .NET Developers</a></li><li><a href="https://docs.microsoft.com/cli/azure/containerapp?view=azure-cli-latest" target="_blank" rel="noopener noreferrer">az containerapp cli</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/Cloud-Native/blog/tags/serverless-september">serverless-september</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/Cloud-Native/blog/tags/30-days-of-serverless">30-days-of-serverless</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/Cloud-Native/blog/tags/azure-container-apps">azure-container-apps</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/Cloud-Native/blog/tags/dapr">dapr</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/Cloud-Native/blog/tags/microservices">microservices</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/Cloud-Native/blog/tags/30-days-of-serverless/page/8"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Cloud-Native/blog/tags/30-days-of-serverless/page/10"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://azure.microsoft.com/solutions/cloud-native-apps/?WT.mc_id=javascript-74010-ninarasi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cloud Native</a><span class="footer__link-separator">¬∑</span><a href="https://azure.microsoft.com/solutions/serverless/?WT.mc_id=javascript-74010-ninarasi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Serverless</a><span class="footer__link-separator">¬∑</span><a href="https://aka.ms/30DaysOf" target="_blank" rel="noopener noreferrer" class="footer__link-item">#30DaysOf</a><span class="footer__link-separator">¬∑</span><a href="https://developer.microsoft.com/java/?WT.mc_id=javascript-74010-ninarasi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Java</a><span class="footer__link-separator">¬∑</span><a href="https://docs.microsoft.com/javascript/?WT.mc_id=javascript-74010-ninarasi" target="_blank" rel="noopener noreferrer" class="footer__link-item">JavaScript</a><span class="footer__link-separator">¬∑</span><a href="https://dotnet.microsoft.com/?WT.mc_id=javascript-74010-ninarasi" target="_blank" rel="noopener noreferrer" class="footer__link-item">.NET</a><span class="footer__link-separator">¬∑</span><a href="https://docs.microsoft.com/azure/developer/python/?WT.mc_id=javascript-74010-ninarasi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Python</a><span class="footer__link-separator">¬∑</span><a href="https://privacy.microsoft.com/privacystatement" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Statement </a><span class="footer__link-separator">¬∑</span><a href="https://microsoft.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Copyright ¬© 2022 Microsoft</a></div></div></div></footer></div>
<script src="/Cloud-Native/assets/js/runtime~main.2d35ab23.js"></script>
<script src="/Cloud-Native/assets/js/main.e7046595.js"></script>
</body>
</html>